<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="ko"><generator uri="https://jekyllrb.com/" version="3.9.5">Jekyll</generator><link href="http://localhost:4000/feed.xml" rel="self" type="application/atom+xml" /><link href="http://localhost:4000/" rel="alternate" type="text/html" hreflang="ko" /><updated>2025-12-12T20:21:06+09:00</updated><id>http://localhost:4000/feed.xml</id><title type="html">Every Single Day</title><subtitle></subtitle><author><name>Dajeong Park</name></author><entry><title type="html">QueryDSL에서 group_concat SEPARATOR 없이 구분자 처리하기</title><link href="http://localhost:4000/wiki/2025/07/24/queryds-separator.html" rel="alternate" type="text/html" title="QueryDSL에서 group_concat SEPARATOR 없이 구분자 처리하기" /><published>2025-07-24T00:00:00+09:00</published><updated>2025-07-24T00:00:00+09:00</updated><id>http://localhost:4000/wiki/2025/07/24/queryds-separator</id><content type="html" xml:base="http://localhost:4000/wiki/2025/07/24/queryds-separator.html"><![CDATA[<h3 id="배경">배경</h3>

<p>종종 테이블의 여러 개로 들어가 있는 데이터를 List<String>의 형태로 보내야 할 때가 있다. QueryDSL을 사용할 때 이를 위해 보통 group_concat을 사용해 하나의 문자열로 묶은 뒤, DTO에서 String으로 받아 `String.split(”,”)`을 사용하여 List로 변환하하는 방식을 사용하곤 했다.</String></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Expressions</span><span class="o">.</span><span class="na">stringTemplate</span><span class="o">(</span><span class="s">"group_concat({0})"</span><span class="o">,</span> <span class="n">book</span><span class="o">.</span><span class="na">title</span><span class="o">);</span>
</code></pre></div></div>
<p>그런데 이 방식엔 치명적인 문제가 있다.
<br />
<br /></p>

<h3 id="데이터에-쉼표가-들어간다면">데이터에 쉼표가 들어간다면?</h3>
<p>예를 들어, 다음 같은 책 제목이 있다고 할 때</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>"첫 여름, 완주"
"다섯 번째 계절"
</code></pre></div></div>
<p>이 값들을 기존 방식대로 group_concat으로 묶은 뒤 DTO에서 <code class="language-plaintext highlighter-rouge">split(”,”)</code> 처리를 해보자.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">String</span> <span class="n">titles</span> <span class="o">=</span> <span class="s">"첫 여름, 완주, 다섯 번째 계절"</span><span class="o">;</span>
<span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">aresult</span> <span class="o">=</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">titles</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">","</span><span class="o">));</span>
<span class="c1">// ["첫 여름", " 완주", "다섯 번째 계절"]</span>
</code></pre></div></div>

<p>제목 안의 쉼표가 String.split()의 기준이 되어 값이 쪼개져버리는 문제가 발생한다.
<br />
<br /></p>

<h3 id="그럼-separator를-쓰면-되지-않을까">그럼 SEPARATOR를 쓰면 되지 않을까?</h3>
<p>물론 MySQL에서는 <code class="language-plaintext highlighter-rouge">group_concat(… SEPARATOR ‘|||’)</code> 같은 방식으로 구분자를 지정할 수 있다.</p>

<p>하지만 <strong>QueryDSL 내부의 Hibernate에서 이 SEPERATOR를 SQL이 아니라 JPQL로 파싱하려고 하기 때문에 SyntaxException을 발생</strong>하게 된다. 그래서 MySQL 전용 문법인 SEPARATOR를 직접 쓸 수 없다.</p>

<p>참고로 <code class="language-plaintext highlighter-rouge">group_concat</code>을 사용하면 기본적으로 <code class="language-plaintext highlighter-rouge">,(쉼표)</code>를 구분자로 사용한다.
<br />
<br /></p>

<h3 id="해결-querydsl에서-구분자-수동-삽입">해결: QueryDSL에서 구분자 수동 삽입</h3>

<p><code class="language-plaintext highlighter-rouge">group_concat</code>의 기본 구분자를 바꿀 수는 없지만, <strong>각 값 뒤에 원하는 구분자(<code class="language-plaintext highlighter-rouge">|||</code>)를 직접 붙일 수 있다.</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// QueryDSL</span>
<span class="nc">Expressions</span><span class="o">.</span><span class="na">stringTemplate</span><span class="o">(</span>
    <span class="s">"group_concat(distinct concat({0}, '|||'))"</span><span class="o">,</span> <span class="n">book</span><span class="o">.</span><span class="na">title</span>
<span class="o">)</span>

<span class="c1">// DTO</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">convertTitles</span><span class="o">(</span><span class="nc">String</span> <span class="n">titles</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// 쉼표로 분리된 값들을 '|||' 기준으로 나눔</span>
    <span class="k">return</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">titles</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"\\\\|\\\\|\\\\|"</span><span class="o">))</span> 
	    <span class="c1">// 앞에 붙을 수 있는 쉼표 제거</span>
	  <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">","</span><span class="o">)</span> <span class="o">?</span> <span class="n">s</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="o">:</span> <span class="n">s</span><span class="o">)</span>
      <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="o">!</span><span class="n">s</span><span class="o">.</span><span class="na">isBlank</span><span class="o">())</span>
      <span class="o">.</span><span class="na">toList</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>이렇게 하면 <code class="language-plaintext highlighter-rouge">group_concat</code>은 여전히 쉼표로 값을 붙이지만, 각 값의 내부에는 우리가 지정한 구분자(<code class="language-plaintext highlighter-rouge">|||</code>)가 붙어 있어 안전하게 분리할 수 있다.
<br />
<br /> 
<br /></p>

<h3 id="추가-데이터-안에-반드시-쉼표-포함된다면">추가: 데이터 안에 반드시 쉼표 포함된다면?</h3>

<p>만약 데이터 안에 쉼표가 반드시 포함된다면, 다음과 같이 한 번 더 escape 처리하는 것이 안전하다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// QueryDSL</span>
<span class="nc">Expressions</span><span class="o">.</span><span class="na">stringTemplate</span><span class="o">(</span>
    <span class="s">"replace(group_concat(distinct replace({0}, ',', '##COMMA##')), ',', '|||')"</span><span class="o">,</span>
    <span class="n">book</span><span class="o">.</span><span class="na">title</span>
<span class="o">)</span>

<span class="c1">// DTO</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">convertTitles</span><span class="o">(</span><span class="nc">String</span> <span class="n">titles</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="nc">Arrays</span><span class="o">.</span><span class="na">stream</span><span class="o">(</span><span class="n">titles</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s">"\\\\|\\\\|\\\\|"</span><span class="o">))</span>
	    <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.</span><span class="na">replace</span><span class="o">(</span><span class="s">"##COMMA##"</span><span class="o">,</span> <span class="s">","</span><span class="o">))</span>
      <span class="o">.</span><span class="na">toList</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>
<p><br />
<br /></p>

<h3 id="native-query를-사용하지-않은-이유">Native Query를 사용하지 않은 이유</h3>

<p>Native Query를 사용하면 <code class="language-plaintext highlighter-rouge">SEPARATOR</code>나 <code class="language-plaintext highlighter-rouge">ORDER BY</code> 같은 SQL을 QueryDSL보다 자유롭게 쓸 수 있다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Query</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"select group_concat(distinct title SEPARATOR '|||') "</span> <span class="o">+</span>
	<span class="s">"FROM book"</span><span class="o">,</span> <span class="n">nativeQuery</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span>
</code></pre></div></div>

<p>하지만 나는 여러 이유로 QueryDSL 방식을 선택했다.</p>
<ul>
  <li>사용해야 하는 조건이 많음</li>
  <li><strong>타입 안정성</strong>이 유리함</li>
  <li>Native Query는 유지보수 어렵고, 타입 매핑이 불편함</li>
  <li>문자열 조립을 잘못하면 <strong>SQL Injection 위험</strong>도 있음
    <ul>
      <li>QueryDSL에서 파라미터는 내부적으로 <code class="language-plaintext highlighter-rouge">PreparedStatement</code>로 바인딩되기 때문에 <strong>사용자 입력이 직접 쿼리 구조에 들어가지 않으며, SQL Injection 공격으로부터 안전</strong>
<br />
<br />
<br /></li>
    </ul>
  </li>
</ul>

<h3 id="마무리">마무리</h3>
<p>더 좋은 방법이 있을 수 있겠지만 (있다면 댓글 부탁드립니다!)<br />
QueryDSL은 group_concat에서 SEPERATOR를 직접 지정할 순 없지만, 우회적으로 구분자를 삽입하고 후처리하는 방식으로 문제를 충분히 해결할 수 있었다.</p>]]></content><author><name>Dajeong Park</name></author><category term="wiki" /><category term="QueryDSL" /><summary type="html"><![CDATA[배경]]></summary></entry><entry><title type="html">null-safe하게 Optional 사용하기</title><link href="http://localhost:4000/wiki/2025/05/15/java-optional.html" rel="alternate" type="text/html" title="null-safe하게 Optional 사용하기" /><published>2025-05-15T00:00:00+09:00</published><updated>2025-05-15T00:00:00+09:00</updated><id>http://localhost:4000/wiki/2025/05/15/java-optional</id><content type="html" xml:base="http://localhost:4000/wiki/2025/05/15/java-optional.html"><![CDATA[<h3 id="배경">배경</h3>
<p>프로젝트 작업 중 Optional을 자주 사용하고 있다는 걸 인지하게 되었다. 기본 개념부터 주의할 점을 다시 살펴보니, 생각보다 다양한 방식으로 null-safe한 처리가 가능하다는 걸 알게 되었고, 흐름을 더 명확하게 표현할 수 있다는 점도 인상 깊었다. 이번 기회에 Optional을 어떻게 쓰는 것이 바람직한지, 실무에서 자주 하는 실수는 무엇인지 정리해보고자 한다.
<br />
<br /></p>

<h2 id="optional">Optional</h2>
<p><img src="https://dajeongdev.github.io/assets/images/posts/optional.png" /></p>

<ul>
  <li>Java에서 NullPointerException(NPE)은 가장 흔한 런타임 오류 중 하나다.</li>
  <li>Java 8 이전에는 메서드가 null을 반환할 경우, 사용하는 쪽에서 null 여부를 주석이나 문서로만 유추해야 했다.</li>
  <li>Java 8에서 도입된 Optional을 사용하여 null 여부를 명시적으로 표현할 수 있어, map, filter, flatMap 등 함수형 메서드를 지원하여 null-safe한 코드 작성이 가능하다.
<br />
<br /></li>
</ul>

<h2 id="optional-주요-메서드-요약">Optional 주요 메서드 요약</h2>

<table>
  <thead>
    <tr>
      <th>메서드</th>
      <th>설명</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>map()</td>
      <td>내부 값을 가공하고 Optional로 감싸서 제공</td>
    </tr>
    <tr>
      <td>flatMap()</td>
      <td>내부 값이 또 다른 Optional일 때 중첩 방지</td>
    </tr>
    <tr>
      <td>filter()</td>
      <td>조건을 만족할 경우만 값을 유지</td>
    </tr>
    <tr>
      <td>ifPresent()</td>
      <td>값이 있으면 실행 (void 리턴)</td>
    </tr>
    <tr>
      <td>ifPresentOrElse() (Java 9)</td>
      <td>값이 있으면 A 실행, 없으면 B 실행</td>
    </tr>
    <tr>
      <td>orElse()</td>
      <td>값이 없을 경우 기본값 제공</td>
    </tr>
    <tr>
      <td>orElseGet()</td>
      <td>값이 없을 경우 Supplier 실행</td>
    </tr>
    <tr>
      <td>orElseThrow()</td>
      <td>값이 없을 경우 예외 발생</td>
    </tr>
    <tr>
      <td>isPresent()/isEmpty()<br />(Java 11)</td>
      <td>값 존재 여부 확인 (→ 가급적 사용 자제, ifPresent() 등 권장)</td>
    </tr>
    <tr>
      <td>or() (Java 9)</td>
      <td>비어 있을 경우 대체 Optional 제공</td>
    </tr>
    <tr>
      <td>stream (Java 9)</td>
      <td>Optional을 Stream으로 변환</td>
    </tr>
  </tbody>
</table>

<h3 id="orelse와-orelseget">orElse와 orElseGet</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// orElse는 항상 실행</span>
<span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="na">orElse</span><span class="o">(</span><span class="n">getExpensiveDefault</span><span class="o">());</span>

<span class="c1">// orElseGet은 필요할 때만 실행(lazy)</span>
<span class="nc">String</span> <span class="n">name</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="na">orElseGet</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="n">getExpensiveDefault</span><span class="o">());</span>
</code></pre></div></div>

<p>⭐️ <code class="language-plaintext highlighter-rouge">orElse()</code>는 기본값을 항상 먼저 계산하다. 불필요한 리소스 낭비가 되지 않도록, 기본값이 필수가 아니라면 <code class="language-plaintext highlighter-rouge">orElseGet()</code>을 사용하는 것이 좋다.</p>

<h3 id="ispresent-사용-시-주의사항">isPresent() 사용 시 주의사항</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">(</span><span class="n">optionalUser</span><span class="o">.</span><span class="na">isPresent</span><span class="o">())</span> <span class="o">{</span>
	<span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">optionalUser</span><span class="o">.</span><span class="na">get</span><span class="o">();</span> <span class="c1">// 여전히 예외 위험 있음</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>Optional의 목적은 null-safe한 코드를 작성하는 건데, isPresent()를 써서 if문으로 다시 체크한다면 결국 이전 방식(if (value ≠ null)과 다를 바 없기 때문에 Optional을 쓰는 이유가 불분명해지게 된다.
    <ul>
      <li>또한, isPresent()가 true라고 해도 중간에 다른 로직이 추가되면 get() 호출 시점에 Optional이 달라질 수 있어 위험하다.</li>
    </ul>
  </li>
  <li>이럴 때는 아래처럼 명시적인 함수형 스타일을 사용하면 좋다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">optionalUser</span>
	<span class="o">.</span><span class="na">orElseThrow</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">NotFoundException</span><span class="o">(</span><span class="s">"사용자를 찾을 수 없습니다."</span><span class="o">));</span>
</code></pre></div></div>

<ul>
  <li>ifPresent()도 비어있지 않을 때만 수행하는 작업을 표현하기 좋다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">optionalUser</span><span class="o">.</span><span class="na">ifPresent</span><span class="o">(</span><span class="n">user</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
</code></pre></div></div>

<h3 id="filter">filter</h3>

<ul>
  <li>조건에 맞는 값만 유지</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">name</span> <span class="o">=</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"파인애플"</span><span class="o">);</span>
<span class="n">name</span><span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">n</span> <span class="o">-&gt;</span> <span class="n">n</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="o">)</span>
		<span class="o">.</span><span class="na">ifPresent</span><span class="o">(</span><span class="n">n</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"이름이 너무 깁니다. : "</span> <span class="o">+</span> <span class="n">n</span><span class="o">));</span>
</code></pre></div></div>

<h3 id="map">map</h3>

<ul>
  <li>값을 null-safe하게 변환</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">name</span> <span class="o">=</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="s">"파인애플"</span><span class="o">);</span>
<span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Integer</span><span class="o">&gt;</span> <span class="n">nameLength</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">String:</span><span class="o">:</span><span class="n">length</span><span class="o">);</span>
<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"결과: {}"</span><span class="o">,</span> <span class="n">nameLength</span><span class="o">.</span><span class="na">orElse</span><span class="o">(</span><span class="mi">0</span><span class="o">));</span> <span class="c1">// 결과: 4</span>
</code></pre></div></div>

<h3 id="flatmap">flatMap</h3>

<ul>
  <li>중첩된 Optional 해제</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// User- &gt; Optional&lt;Profile&gt;를 반환하는 메서드가 있을 경우</span>
<span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">user</span> <span class="o">=</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="k">new</span> <span class="nc">User</span><span class="o">());</span>

<span class="nc">String</span> <span class="n">email</span> <span class="o">=</span> <span class="n">user</span>
	<span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="nl">User:</span><span class="o">:</span><span class="n">getProfile</span><span class="o">)</span> <span class="c1">// Optional&lt;Profile&gt;</span>
	<span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Profile:</span><span class="o">:</span><span class="n">getEmail</span><span class="o">)</span>    <span class="c1">// Optional&lt;String&gt;</span>
	<span class="c1">// map을 안 쓰면 Optioanl&lt;Optional&lt;String&gt;&gt;이 되어버림</span>
	<span class="o">.</span><span class="na">orElse</span><span class="o">(</span><span class="s">"이메일 정보 없음"</span><span class="o">);</span>
</code></pre></div></div>
<p><br />
<br /></p>

<h2 id="optional-지양해야-할-사용법"><strong>Optional 지양해야 할 사용법</strong></h2>

<h3 id="1-무분별한-optionalget-사용">1. 무분별한 Optional.get() 사용</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">1L</span><span class="o">);</span>
<span class="o">**</span><span class="nc">User</span> <span class="n">u</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="na">get</span><span class="o">();**</span> 
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">Optional.get()</code>은 내부에 값이 없을 경우 런타임 예외(NoSuchElementException) 발생하며, null-safe하게 코드를 작성하려고 Optional을 쓰는데, get()을 쓰면 그 의미가 사라진다.</li>
  <li>isPresent()와 함께 쓰더라도, 유지보수 중에 변경되면 예외 발생 가능성 존재한다.</li>
</ul>

<p><strong>👍 대안:</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">1L</span><span class="o">)</span>
		<span class="o">.</span><span class="na">orElseThrow</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">CommonException</span><span class="o">(</span><span class="nc">ErrorCode</span><span class="o">.</span><span class="na">NOT_FOUND</span><span class="o">));</span>
</code></pre></div></div>
<ul>
  <li><code class="language-plaintext highlighter-rouge">orElse()</code>이나 <code class="language-plaintext highlighter-rouge">orElseThrow()</code> 사용</li>
</ul>

<h3 id="2-필드에--사용">2. 필드에  사용</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">name</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>JPA, Jackson, Hibernate 등 직렬화/역직렬화/매핑 과정에서 오류가 발생할 수 있다.</li>
  <li>필드는 일반적으로 객체의 상태를 표현하는데, Optional은 계산 결과나 조건적 반환을 위한 용도라 맞지 않는고, 메모리 낭비 및 불필요한 래핑으로 가독성이 저하될 수 있다.</li>
</ul>

<p><strong>👍 대안:</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
	<span class="kd">public</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="nf">getNameOptional</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>필드는 일반 타입으로 선언, getter에서 Optional로 감싸는 방식 권장한다.</li>
</ul>

<h3 id="3-파라미터나-리턴값으로-사용">3. 파라미터나 리턴값으로 사용</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateName</span><span class="o">(</span><span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">name</span><span class="o">)</span> <span class="c1">// 잘못된 설계</span>
</code></pre></div></div>
<ul>
  <li>Optional은 메서드 결과를 감싸기 위한 목적이지, 인자로 전달하는 용도가 아니며, 오히려 사용하는 쪽에서 of(), empty() 등을 강제하게 되어 복잡도가 증가한다.</li>
</ul>

<p><strong>👍 대안:</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateName</span><span class="o">(</span><span class="nc">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
	<span class="c1">// 내부에서 Optional.ofNullable(name)으로 처리</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>메서드 인자는 기본 타입으로 받고, 내부에서 Optional.ofNullable()로 처리한다.
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(...);</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>리턴 타입으로 Optional을 쓰면 “값이 없을 수도 있다”라는 의도가 명확하게 드러나므로 좋다.
<br />
<br /></li>
</ul>

<h2 id="optional-단점">Optional 단점</h2>

<h3 id="1-성능-오버헤드">1. 성능 오버헤드</h3>
<ul>
  <li>Optional은 결국 하나의 래퍼 객체로, 값 하나를 감싸기 위해 객체가 추가로 생성된다. 특히 빈 Optional 객체는 재사용되지만, 값이 있을 경우 매번 Optional.of()로 새 인스턴스를 생성한다.</li>
  <li>자주 호출되는 메서드에서 Optional을 남발하면 GC에 부담이 증가하고, 성능 저하 가능성이 높아진다.</li>
</ul>

<h3 id="2-체이닝이-지나치면-가독성-저하">2. 체이닝이 지나치면 가독성 저하</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">Optional</span><span class="o">.</span><span class="na">ofNullable</span><span class="o">(</span><span class="n">user</span><span class="o">)</span>
    <span class="o">.</span><span class="na">flatMap</span><span class="o">(</span><span class="nl">User:</span><span class="o">:</span><span class="n">getProfile</span><span class="o">)</span>
    <span class="o">.</span><span class="na">map</span><span class="o">(</span><span class="nl">Profile:</span><span class="o">:</span><span class="n">getEmail</span><span class="o">)</span>
    <span class="o">.</span><span class="na">filter</span><span class="o">(</span><span class="n">email</span> <span class="o">-&gt;</span> <span class="n">email</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s">".com"</span><span class="o">))</span>
    <span class="o">.</span><span class="na">orElse</span><span class="o">(</span><span class="s">"이메일 없음"</span><span class="o">);</span>
</code></pre></div></div>
<ul>
  <li>함수형 스타일은 깔끔해 보일 수 있지만, 익숙하지 않은 개발자에겐 오히려 난해하다. 특히 예외 처리나 조건 분기가 복잡할 수록 명령형 코드보다 읽기 어려워질 수 있다.
<br />
<br /></li>
</ul>

<h2 id="optional을-사용하는-바람직한-위치">Optional을 사용하는 바람직한 위치</h2>
<p>| 계층 | 사용 여부 | 이유 |
| — | — | — |
| Repository | 리턴값 | 조회 결과가 없을 수 있다는 의도를 명확히 드러냄 |
| Service | 내부 처리/변환 시 | Optional을 바로 처리해서 도메인 객체로 변환하거나 예외 처리 |
| Controller | ❌ | 응답 객체는 명확하고 단순한 타입이 바람직하므로 Optional 노출 지양 |</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Repository</span>
<span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">User</span><span class="o">&gt;</span> <span class="nf">findById</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">);</span>

<span class="c1">// Service</span>
<span class="kd">public</span> <span class="nc">User</span> <span class="nf">findUserOrThrow</span><span class="o">(</span><span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
			<span class="o">.</span><span class="na">orElseThrow</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">CommonException</span><span class="o">(</span><span class="nc">ErrorCode</span><span class="o">.</span><span class="na">NOT_FOUND_USER</span><span class="o">));</span>
<span class="o">}</span>

<span class="c1">// Controller</span>
<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"/users/{id}"</span><span class="o">)</span>
<span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">UserResponse</span><span class="o">&gt;</span> <span class="nf">getUser</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
	<span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userService</span><span class="o">.</span><span class="na">findUserOrThrow</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
	<span class="k">return</span> <span class="nc">ResponseEntity</span><span class="o">.</span><span class="na">ok</span><span class="o">(</span><span class="nc">UserResponse</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">user</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div></div>
<p>➡️ Repository는 Optional로 감싸서 리턴하고, Service에서 처리하고, Controller에서는 노출하지 않는 것이 바람직하다.
<br />
<br /></p>

<h2 id="optional과-validationexception-처리">Optional과 Validation/Exception 처리</h2>

<p>**1. Optional로 조건 분기 없이 깔끔한 예외 처리 가능하다.  **</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nc">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">userRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
	<span class="o">.</span><span class="na">orElseThrow</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="k">new</span> <span class="nc">CommonException</span><span class="o">(</span><span class="nc">ErrorCode</span><span class="o">.</span><span class="na">NOT_FOUND_USER</span><span class="o">));</span>
</code></pre></div></div>
<ul>
  <li>orElseThrow()를 활용하면 null 체크와 예외 처리를 한 줄로 처리 가능하다.</li>
</ul>

<p><strong>2. Validation과의 연계는 Optional 밖에서 수행한다.</strong></p>
<ul>
  <li>입력값이 Optional인 경우, Spring Validation에서는 제대로 처리되지 않을 수 있으므로, 요청 DTO에는 기본 타입으로 선언하고, 이후 변환 시 Optional을 사용한다.
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserRequest</span> <span class="o">{</span>
      <span class="nd">@NotBlank</span>
      <span class="kd">private</span> <span class="nc">String</span> <span class="n">name</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div>    </div>
  </li>
  <li>받은 값이 null일 수 있다면, Service 계층에서 Optional.ofNullable(request.getName())으로 감싸서 처리하는 것이 낫다.
<br />
<br /></li>
</ul>

<h2 id="마무리">마무리</h2>
<p>Optional은 제대로 사용하면 강력한 null-safe 도구지만, 목적에 맞지 않게 사용하거나 남용할 경우 오히려 가독성과 성능을 저하시킬 수 있으므로, 많이 사용할 수록 바람직한 방식으로 사용하는 것이 중요하다.</p>

<p>✅ Optional은 리턴에만 적절하게 사용<br />
❌ get(), isPresent() 남용 금지<br />
🧩 orElseGet(), orElse 차이 유의<br /></p>]]></content><author><name>Dajeong Park</name></author><category term="wiki" /><category term="Java" /><category term="Java8" /><category term="Optional" /><summary type="html"><![CDATA[배경 프로젝트 작업 중 Optional을 자주 사용하고 있다는 걸 인지하게 되었다. 기본 개념부터 주의할 점을 다시 살펴보니, 생각보다 다양한 방식으로 null-safe한 처리가 가능하다는 걸 알게 되었고, 흐름을 더 명확하게 표현할 수 있다는 점도 인상 깊었다. 이번 기회에 Optional을 어떻게 쓰는 것이 바람직한지, 실무에서 자주 하는 실수는 무엇인지 정리해보고자 한다.]]></summary></entry><entry><title type="html">조금 늦은 글또 회고</title><link href="http://localhost:4000/blog/2025/05/02/review-geultto.html" rel="alternate" type="text/html" title="조금 늦은 글또 회고" /><published>2025-05-02T00:00:00+09:00</published><updated>2025-05-02T00:00:00+09:00</updated><id>http://localhost:4000/blog/2025/05/02/review-geultto</id><content type="html" xml:base="http://localhost:4000/blog/2025/05/02/review-geultto.html"><![CDATA[<p><img src="https://dajeongdev.github.io/assets/images/posts/review-geultto.jpeg" /></p>

<p>한 달이나 지나서 작성하는 글또 회고,, 반성합니다.</p>

<p>글또는 내가 작년에 한 일 중 가장 잘한 일로 손꼽힌다. 원래 마지막 글은 회고글을 제출하고 싶었지만, 공들여보고 싶은 마음에 미룬다는 게 지금까지 미루게 되었다.</p>

<p>그렇다면 내가 글또를 통해 뭘 배우고 싶었을까? 그걸 알기 위해서 글또에서 처음으로 작성한 글과 올해 목표를 다시 돌아보았다.</p>

<h3 id="첫-번째-글의-다짐">첫 번째 글의 다짐</h3>
<ol>
  <li>좋은 글을 많이 보고 글감에 대해 고민해보기</li>
  <li>글을 쓰는 재미와 방법에 대해 알아가기</li>
</ol>

<h3 id="올해-목표">올해 목표</h3>
<ol>
  <li><strong>글또 참여율 높이기</strong></li>
  <li><strong>꾸준히 글 쓰기</strong></li>
  <li><strong>트러블슈팅 바로바로</strong></li>
  <li><strong>테스트 코드 등으로 역량 넓히기</strong></li>
  <li><strong>코딩테스트 관련 공부</strong></li>
  <li><strong>질 좋은 의사소통</strong></li>
  <li><strong>준비된 체력</strong></li>
  <li><strong>도파민 줄이기</strong></li>
</ol>

<p>반은 해내고 반은 그렇지 못했지만, 그래도 남는 게 더 많았다.</p>

<p>확실히 글또 시작 때보다 올해 더 많은 사람을 만나고 참여했고, 올해는 패스 없이 글도 모두 작성했다.</p>

<p>그리고 업무를 진행하면서 틈틈이 트러블슈팅을 작성한 덕분에 글을 작성하는 게 더 수월하기도 했다.</p>

<p>테스트 코드 강의도 반 정도는 들었고, 2월부터는 설계 스터디를 진행하고 있는데 벌써 거의 마무리 단계가 다가오고 있다. 좋은 팀원들을 만나서 어려운 부분도 나름 재미있게 배워가고 있다.</p>

<p>아쉽게도 코딩테스트 준비는 전혀 하지 못했다,, 설계 스터디에 테스트 코드 강의를 듣기도 너무 바빴다.. 5월까지는 이번 프로젝트 마감으로 바쁠테니 6월부터 스터디를 구하든지 해서 꼭 준비해봐야지❗️</p>

<p>의사소통에 관련해서는 많은 생각이 들었다. 잘 맞는 사람들이랑만 일할 수 없기 때문에 내 마음가짐을 고쳐먹는 게 중요했다. 주어를 얘기해주지 않거나 불명확하게 얘기해주시는 부분에 대해서 정확하게 얘기해달라고 말씀드리고, 내가 모르는 부분은 모른다고 빨리 인정하고 얘기하는 것. 일단 이것부터 하고 있다. 좋은 의사소통에 관련해서는 올해 계속 생각을 만들어가보려고 한다.</p>

<p>운동은 올해 잘하고 있는 부분 중 하나인데, 필라테스를 끝내고 PT를 시작했다. 나름 잘 배우고 있지만, 근육량이 쉽게 늘지 않는 것에 스트레스를 받지 않으려고 노력하고 있다. PT쌤 덕분에 10km 레이스도 처음 나가봤는데, 재미있었지만 사람들이 너무 많아서 자주는 못할 것 같다.. 이제 날씨도 좋아졌으니 웨이트와 러닝을 적절히 섞어서 더 좋은 체력을 만들어봐야지.</p>

<p>도파민 줄이기도 나름 잘해냈다. 핸드폰 게임도 삭제했고, 출퇴근길에 말해보카와 독서를 하면서 올해 벌써 6권의 책을 읽었다. 또 글또 독서모임도 덕분에 안 읽어볼 법한 책도 읽게 되어서 너무 재미있다.
<br />
<br /></p>

<h3 id="글-목록">글 목록</h3>
<p>처음 목표는 패스 하나도 안 쓰기였는데.. 🥹 1번의 패스를 사용하고, 1번은 글 제출 마감일날 버저비터를 누르려다가 실패해서 미제출이 되었다.. 💦 내 업보이니라…</p>

<ul>
  <li>기술/언어 관련 <strong>8개</strong></li>
  <li>회고 관련 글 <strong>2개</strong></li>
</ul>

<p>그래서 이번 글또 활동을 통해 10개의 글을 제출했는데, 돌아보니 회고글이 생각보다 적어서 의외였다. 큐레이션에 한 번이라도 선정되고 싶었으나, 선정되는 글을 보니 정말정말 잘 쓰시는 분들이라 오히려 나도 앞으로 그런 글을 쓸 수 있도록 노력해야겠다는 생각이 많이 들었다.
<br />
<br /></p>

<h3 id="글또-후기">글또 후기</h3>
<p>4월에 한 개도 쓰지 못해서 글 쓰는 습관이 들었다고 하기 민망하지만, 그래도 글또 덕분에 글에 대한 좋은 인식이 생겼다. 마냥 어렵고 막막하기만 했는데, 이제 조금은 어떻게 써야할지 알게 되었고, 무엇보다 잘 쓰고 싶은 마음이 들어 앞으로 글 쓰는 방법에 대해서 많이 고민하고 알아볼 것이다.</p>

<p>무엇보다 글또를 통해 사람들과 만나면서 확실히 동기부여를 많이 얻었다. 예상보다 많은 활동을 하지 않았지만, 다진마늘을 통해 세운 계획들도 많이 해냈고 달리또에는 가끔 글을 올려도 많은 분들이 응원을 해주셔서 힘이 났다. 또 삶의 지또를 통해 내 삶을 다시 돌아보면서 내가 어떻게 살아왔는지, 내 가치관은 어떻게 형성되었는지, 또 내게 무엇이 중요한지 등 나 자신에 대해 많이 돌아볼 수 있어서 너무 소중한 경험이 되었다. 지금 진행 중인 설계 스터디도 글또 홍보 글에 올려주셔서 할 수 있었고, 올해 가장 힘들 때 업그레이또 커피챗 덕분에 빨리 털어버릴 수 있었다. 이곳에서 만난 인연들이 오래 지속될 수 있도록 나도 많이 노력해야지.</p>

<p>글또에 가입했을 때의 기대보다 더 많은 걸 얻어서 나도 앞으로 이 업계에서 좋은 영향력을 주고받을 수 있으면 좋겠다는 목표도 생겼다. 아직 내가 직업적으로 뭘 잘하는지 잘 모르겠지만 그런 부분을 빨리 파악해서 다른 사람들에게 도움을 줄 수 있으면 좋겠다.</p>

<p>마지막으로 글또에서 활동해주신 모든 분들 덕분에 상반기 열심히 성장한 것 같아서 너무 감사드린다는 말을 전해드리고 싶습니다! 🫶</p>]]></content><author><name>Dajeong Park</name></author><category term="blog" /><category term="글또" /><category term="회고" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">Spring @Transactional을 정말 제대로 쓰고 있는 걸까?</title><link href="http://localhost:4000/wiki/2025/03/28/spring-transactional-annotation.html" rel="alternate" type="text/html" title="Spring @Transactional을 정말 제대로 쓰고 있는 걸까?" /><published>2025-03-28T00:00:00+09:00</published><updated>2025-03-28T00:00:00+09:00</updated><id>http://localhost:4000/wiki/2025/03/28/spring-transactional-annotation</id><content type="html" xml:base="http://localhost:4000/wiki/2025/03/28/spring-transactional-annotation.html"><![CDATA[<p>우리는 수많은 데이터를 저장하고 수정하며, 그 과정에서 데이터의 무결성을 보장하는 것이 얼마나 중요한지 깨닫게 된다. 특히 JPA와 Spring을 활용하는 환경에서는 트랜잭션을 제대로 관리하지 않으면 예상치 못한 문제가 발생할 수 있다.<br />
JPA를 처음 접했을 때, 엔티티의 값을 바꾸면 자동으로 UPDATE 쿼리가 나가는 게 꽤 신기했다. 그런데 막상 실무에서 코드를 작성하다 보면 “왜 업데이트가 안 되지?”, “왜 데이터가 반영되지 않았지?” 하는 순간들을 겪게 된다.<br />
그런 경험을 통해 JPA의 변경 감지가 트랜잭션 범위 내에서만 동작한다는 점을 알게 되고, 결국 @Transactional 애노테이션의 필요성을 체감하게 된다. 또 @Transactional(readOnly = true) 옵션을 활용하면 조회 성능을 최적화할 수 있다는 것도 알게 됐다.<br />
결국 중요한 건 단순히 @Transactional을 붙이는 게 아니라, 트랜잭션이 어떻게 동작하는지를 이해하고, 상황에 맞는 옵션을 적용하는 것이다.
<br />
<br /></p>

<h3 id="trasaction">Trasaction</h3>
<p>Spring에서는 트랜잭션 처리를 간편하게 하기 위해 <code class="language-plaintext highlighter-rouge">@Transactional</code> 애노테이션을 제공한다. 본격적으로 이 애노테이션을 살펴보기 전에, 먼저 트랜잭션 자체에 대해 간단히 짚고 넘어가자.
트랜잭션(Transaction)은 사전적으로는 ‘거래’라는 뜻이지만, 개발에서는 데이터를 일관성 있게 처리하기 위한 작업 단위로 이해하면 된다.
<br /></p>

<h4 id="예시">예시</h4>
<p>예를 들어, 손님이 키오스크로 아메리카노를 한 잔 주문했다고 해보자. 
내부적으로는 다음과 같은 작업이 순서대로 일어난다.</p>
<ol>
  <li>아메리카노 재고 확인</li>
  <li>손님의 카드 계좌에서 잔액 확인</li>
  <li>계좌에서 아메리카노 가격만큼 차감</li>
  <li>아메리카노 재고 차감</li>
  <li>주문 완료, 영수증 출력</li>
</ol>

<p>이 모든 작업은 <strong>모두 성공하거나, 하나라도 실패하면 전체가 취소</strong>되어야 한다. 
그래야 손님의 돈만 빠져나가고 음료가 나오지 않는 상황을 방지할 수 있다. 
이처럼 하나의 단위로 묶여 처리돼야 하는 작업을 ‘<strong>트랜잭션’</strong>이라고 한다.<br />
<br /></p>

<h4 id="트랜잭션의-4가지-특징-acid">트랜잭션의 4가지 특징 (ACID)</h4>
<ol>
  <li><strong>원자성(Atomicity)</strong>
<br />
- 모든 작업은 전부 성공하거나 전부 실패해야 한다.</li>
  <li><strong>일관성(Consistency)</strong>
<br />
- 트랜잭션 전후로 데이터는 항상 유효한 상태여야 한다. (예: 재고가 음수가 되면 안 됨)</li>
  <li><strong>격리성(Isolation)</strong>
<br />
- 동시에 여러 트랜잭션이 실행되어도 서로 간섭하지 않아야 한다.</li>
  <li><strong>지속성(Durability)</strong>
<br />
- 트랜잭션이 성공적으로 완료되면 그 결과는 영구적으로 반영되어야 한다.
<br />
<br /></li>
</ol>

<h3 id="transactional-애노테이션">@Transactional 애노테이션</h3>
<p>Spring에서는 <code class="language-plaintext highlighter-rouge">@Transactional</code>을 통해 트랜잭션을 선언적으로 관리할 수 있다. 이 애노테이션을 붙이면, 메서드 실행 전후로 트랜잭션을 시작하고 커밋하거나 롤백하는 동작을 자동으로 처리해준다.</p>

<h4 id="동작-방식">동작 방식</h4>
<p>Spring의 <code class="language-plaintext highlighter-rouge">@Transactional</code>은 AOP(관점 지향 프로그래밍) 기반으로 동작한다. 정확히는 프록시 객체가 생성되고, 이 프록시가 메서드 실행 전후로 트랜잭션을 관리한다.</p>
<ol>
  <li><code class="language-plaintext highlighter-rouge">@Transactional</code>이 붙은 메서드 호출</li>
  <li>프록시가 트랜잭션 시작</li>
  <li>메서드 실행</li>
  <li>예외 없으면 커밋, 예외 발생 시 롤백</li>
</ol>

<p>단, 이 구조 때문에 <strong>자기 자신 내부에서 메서드를 호출하면 트랜잭션이 적용되지 않는</strong> 문제가 있다.
<br />
<br /></p>

<h3 id="주요-옵션">주요 옵션</h3>

<table>
  <thead>
    <tr>
      <th>옵션</th>
      <th>설명</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">propagation</code></td>
      <td>트랜잭션 전파 방식 (예: <code class="language-plaintext highlighter-rouge">REQUIRED</code>, <code class="language-plaintext highlighter-rouge">REQUIRES_NEW</code>, <code class="language-plaintext highlighter-rouge">NESTED</code> 등)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">isolation</code></td>
      <td>트랜잭션 격리 수준 (<code class="language-plaintext highlighter-rouge">READ_COMMITTED</code>, <code class="language-plaintext highlighter-rouge">SERIALIZABLE</code> 등)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">rollbackFor</code></td>
      <td>어떤 예외 발생 시 롤백할지 지정 (기본은 <code class="language-plaintext highlighter-rouge">RuntimeException</code>과 <code class="language-plaintext highlighter-rouge">Error</code>만 롤백)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">readOnly</code></td>
      <td>읽기 전용 트랜잭션 여부 (쿼리 최적화에 사용)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">timeout</code></td>
      <td>트랜잭션 제한 시간 초과 시 롤백</td>
    </tr>
  </tbody>
</table>

<h4 id="readonly--true">readOnly = true</h4>
<p>조회만 수행하는 메서드라면 <code class="language-plaintext highlighter-rouge">@Transactional(readOnly = true)</code> 설정을 통해 성능을 최적화할 수 있다. 이 설정이 있으면 JPA는 변경 감지(Dirt Checking)를 위한 스냅샷을 저장하지 않으므로, 불필요한 리소스를 줄일 수 있다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="c1">// 조회 성능 최적화</span>
<span class="kd">public</span> <span class="nc">Book</span> <span class="nf">findBook</span><span class="o">(</span><span class="nc">Long</span> <span class="n">bookId</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">bookRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">bookId</span><span class="o">).</span><span class="na">orElseThrow</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<p>클래스 전체에 설정할 수도 있고, 메서드 단위로 오버라이드도 가능하다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="nd">@Transactional</span><span class="o">(</span><span class="n">readOnly</span> <span class="o">=</span> <span class="kc">true</span><span class="o">)</span> <span class="c1">// 모든 메서드 조회 전용</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BookService</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="nc">Book</span> <span class="nf">findBook</span><span class="o">(</span><span class="nc">Long</span> <span class="n">bookId</span><span class="o">)</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>

    <span class="nd">@Transactional</span> <span class="c1">// 이 메서드는 readOnly 적용되지 않음</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateBook</span><span class="o">(</span><span class="nc">Long</span> <span class="n">bookId</span><span class="o">,</span> <span class="nc">String</span> <span class="n">title</span><span class="o">)</span> <span class="o">{</span> <span class="o">...</span> <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p><br />
<br /></p>

<h3 id="실무에서-주의할-점"><strong>실무에서 주의할 점</strong></h3>
<h4 id="1-자기-자신을-호출하는-메서드는-트랜잭션이-적용되지-않음">1. <strong>자기 자신을 호출하는 메서드는 트랜잭션이 적용되지 않음</strong></h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderService</span> <span class="o">{</span>

    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">outerMethod</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">innerMethod</span><span class="o">();</span> <span class="c1">// 트랜잭션 적용되지 않음</span>
    <span class="o">}</span>

    <span class="nd">@Transactional</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">innerMethod</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 실제 트랜잭션 적용되지 않음 (프록시를 거치지 않음)</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p>❓ @Transactional은 프록시 기반이기 때문에, 이 프록시가 메서드 호출을 가로채서 트랜잭션을 관리한다. 하지만 동일한 클래스 내에서 메서드가 자기 자신을 호출하는 경우에는 자기 호출(Self-Invocation)로 인식되어 프록시를 거치지 않기 때문에 innerMethod()의 트랜잭션은 처리되지 않는다.
<strong>➡️</strong> innerMethod를 별도 클래스/빈으로 분리하거나, <code class="language-plaintext highlighter-rouge">AopContext.currentProxy()</code>로 직접 호출 (비추천)</p>

<h4 id="2-기본-롤백-대상은-runtimeexception만-가능하다">2. 기본 롤백 대상은 RuntimeException만 가능하다.</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Transactional</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">doSomething</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">Exception</span><span class="o">();</span> <span class="c1">// 롤백되지 않음</span>
<span class="o">}</span>
</code></pre></div></div>
<p>❓ 일반적인 Exception이나 CheckedException은 기본적으로 롤백 대상이 아니다.
<strong>➡️</strong> <code class="language-plaintext highlighter-rouge">@Transactional(rollbackFor = Exception.class)</code> 같이 명시적으로 지정</p>

<h4 id="3-중첩-트랜잭션-nested-transaction">3. 중첩 트랜잭션 (Nested Transaction)</h4>
<p><code class="language-plaintext highlighter-rouge">REQUIRES_NEW</code>는 기존 트랜잭션을 중단하고 새 트랜잭션을 시작하는 방식이다. 이는 실제 중첩 트랜잭션(NESTED)과는 다르며, 구현체에 따라 지원 여부가 달라질 수 있다. 성능이나 롤백 범위에 주의가 필요하다.</p>

<h4 id="4-readonly--true-설정">4. readOnly = true 설정</h4>
<p>readOnly 설정이 있는 트랜잭션 안에서 <code class="language-plaintext highlighter-rouge">INSERT</code>, <code class="language-plaintext highlighter-rouge">UPDATE</code> 등의 작업을 하면 DB 종류에 따라 에러가 나거나 무시될 수 있다. 꼭 조회 전용 메서드에서만 사용하는 것이 좋다.
<br />
<br /></p>

<h3 id="insight--thoughts">insight &amp; thoughts</h3>
<p>처음에는 그냥 애노테이션 하나 붙이면 되는 거 아닌가?라고 생각했지만, 실무에서 직접 트랜잭션 이슈를 겪다 보면 이게 왜 필요한지를 체감하게 된다. 특히, JPA의 변경 감지, 트랜잭션 경계, readOnly 최적화, 롤백 동작 방식을 이해하면 단순히 동작하는 코드를 넘어서 신뢰할 수 있는 코드를 만들 수 있다. 이제는 트랜잭션을 단순한 기술 요소가 아니라, 데이터 정합성을 지키기 위한 개념으로 받아들이게 된 것 같다.
<br />
<br />
<br /></p>

<p><strong>참고</strong></p>
<ul>
  <li><a href="https://docs.spring.io/spring-framework/reference/data-access/transaction/declarative/annotations.html">Spring 공식 문서</a></li>
  <li><a href="https://tech.kakaopay.com/post/jpa-transactional-bri">JPA Transactional 잘 알고 쓰고 계신가요?</a></li>
  <li><a href="https://m42-orion.tistory.com/160">@Transactional의 동작 방식 &amp; 중첩이 일어났을 때 어떻게 될까?</a></li>
</ul>]]></content><author><name>Dajeong Park</name></author><category term="wiki" /><category term="Spring" /><category term="Transactional" /><summary type="html"><![CDATA[우리는 수많은 데이터를 저장하고 수정하며, 그 과정에서 데이터의 무결성을 보장하는 것이 얼마나 중요한지 깨닫게 된다. 특히 JPA와 Spring을 활용하는 환경에서는 트랜잭션을 제대로 관리하지 않으면 예상치 못한 문제가 발생할 수 있다. JPA를 처음 접했을 때, 엔티티의 값을 바꾸면 자동으로 UPDATE 쿼리가 나가는 게 꽤 신기했다. 그런데 막상 실무에서 코드를 작성하다 보면 “왜 업데이트가 안 되지?”, “왜 데이터가 반영되지 않았지?” 하는 순간들을 겪게 된다. 그런 경험을 통해 JPA의 변경 감지가 트랜잭션 범위 내에서만 동작한다는 점을 알게 되고, 결국 @Transactional 애노테이션의 필요성을 체감하게 된다. 또 @Transactional(readOnly = true) 옵션을 활용하면 조회 성능을 최적화할 수 있다는 것도 알게 됐다. 결국 중요한 건 단순히 @Transactional을 붙이는 게 아니라, 트랜잭션이 어떻게 동작하는지를 이해하고, 상황에 맞는 옵션을 적용하는 것이다.]]></summary></entry><entry><title type="html">토스페이먼츠 해외결제(Paypal, 해외카드, Alipay) 연동 후기</title><link href="http://localhost:4000/wiki/2025/03/12/tosspayments-global-payment.html" rel="alternate" type="text/html" title="토스페이먼츠 해외결제(Paypal, 해외카드, Alipay) 연동 후기" /><published>2025-03-12T00:00:00+09:00</published><updated>2025-03-12T00:00:00+09:00</updated><id>http://localhost:4000/wiki/2025/03/12/tosspayments-global-payment</id><content type="html" xml:base="http://localhost:4000/wiki/2025/03/12/tosspayments-global-payment.html"><![CDATA[<p>프로젝트 진행 중 토스페이먼츠를 통해 해외결제를 진행하게 되었는데, 제공해준 가이드가 깔끔하고 구체적이었지만 개인적으로 헤맨 부분이 많아 정리해 볼 겸 작성하게 되었습니다. 
해외결제 중 Paypal, 해외카드, Alipay 세 가지를 작업하며 겪은 트러블슈팅까지 작성해두었으니 누군가에게 도움이 되었으면 좋겠습니다.
<br />
<br /></p>

<h3 id="시작-전-주의사항-️">시작 전 주의사항 ⚠️</h3>
<ul>
  <li>해외결제는 모든 계약이 선행되어야 합니다.</li>
  <li>국내결제, 브랜드페이, 해외결제를 모두 사용하기 위해 결제위젯를 웹뷰(Thymeleaf)로 구현하였습니다.</li>
  <li>국내결제, 브랜드페이를 이미 구현하였으므로, successUrl과 failUrl이 개발되어 있다는 전제하에 글을 작성하였습니다.
<br /></li>
</ul>

<h3 id="요구사항">요구사항</h3>
<ul>
  <li>Paypal와 Alipay는 달러로, 해외카드는 원화로 결제합니다.</li>
  <li>최근 해외카드도 달러로 결제하는 시스템이 도입되었습니다.
<br />
<br /></li>
</ul>

<h2 id="paypal">Paypal</h2>
<h3 id="결제위젯-웹뷰">결제위젯 웹뷰</h3>
<p>‘<a href="https://docs.tosspayments.com/guides/v2/learn/foreign-payment">해외결제 연동</a>’ 가이드에 해외카드와 함께 있는 주문서(javascript) 코드는 구체적이지 않아 결제위젯 &gt; ‘<a href="https://docs.tosspayments.com/guides/v2/payment-widget/integration-paypal">Paypal 연동하기</a>’ 가이드에 있는 주문서(javascript) 코드를 참고하였습니다.
Paypal 연동하기 가이드에서 테스트용 페이팔 계정도 제공하고 있으니 참고해서 개발하시면 좋겠습니다.</p>

<h3 id="trouble-shooting-">Trouble Shooting 💫</h3>
<p><img src="https://github.com/user-attachments/assets/46b260fc-ab90-41d1-b792-92ae94e332b5" alt="Image" />
테스트를 진행하면서 결제 승인의 결과로 Payment 객체를 받습니다. 그런데 이미 국내 결제와 브랜드페이를 작업하면서 easyPay라는 필드를 <strong>객체</strong>로 받고 있었는데, Paypal의 경우 easyPay 필드에 객체가 아닌 “페이팔”이나 ”paypal”이라는 <strong>String</strong>을 전달하고 있었습니다.<br />
그래서 JsonDeserializer를 사용해서 객체일 때와 String일 때를 구분해서 연결해주었습니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">EasyPayDtoDeserializer</span> <span class="kd">extends</span> <span class="nc">JsonDeserializer</span><span class="o">&lt;</span><span class="nc">TossPaymentDto</span><span class="o">.</span><span class="na">EasyPayDto</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">TossPaymentDto</span><span class="o">.</span><span class="na">EasyPayDto</span> <span class="nf">deserialize</span><span class="o">(</span><span class="nc">JsonParser</span> <span class="n">parser</span><span class="o">,</span> <span class="nc">DeserializationContext</span> <span class="n">context</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="nc">JsonNode</span> <span class="n">node</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="na">getCodec</span><span class="o">().</span><span class="na">readTree</span><span class="o">(</span><span class="n">parser</span><span class="o">);</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">node</span><span class="o">.</span><span class="na">isTextual</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// String일 때</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nc">TossPaymentDto</span><span class="o">.</span><span class="na">EasyPayDto</span><span class="o">(</span><span class="n">node</span><span class="o">.</span><span class="na">asText</span><span class="o">(),</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
            <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">node</span><span class="o">.</span><span class="na">isObject</span><span class="o">())</span> <span class="o">{</span> <span class="c1">// 객체일 때</span>
                <span class="nc">String</span> <span class="n">provider</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">has</span><span class="o">(</span><span class="s">"provider"</span><span class="o">)</span> <span class="o">?</span> <span class="n">node</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"provider"</span><span class="o">).</span><span class="na">asText</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
                <span class="kt">int</span> <span class="n">amount</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">has</span><span class="o">(</span><span class="s">"amount"</span><span class="o">)</span> <span class="o">?</span> <span class="n">node</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"amount"</span><span class="o">).</span><span class="na">asInt</span><span class="o">()</span> <span class="o">:</span> <span class="mi">0</span><span class="o">;</span>
                <span class="kt">int</span> <span class="n">discountAmount</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="na">has</span><span class="o">(</span><span class="s">"discountAmount"</span><span class="o">)</span> <span class="o">?</span> <span class="n">node</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"discountAmount"</span><span class="o">).</span><span class="na">asInt</span><span class="o">()</span> <span class="o">:</span> <span class="mi">0</span><span class="o">;</span>
                <span class="k">return</span> <span class="k">new</span> <span class="nc">TossPaymentDto</span><span class="o">.</span><span class="na">EasyPayDto</span><span class="o">(</span><span class="n">provider</span><span class="o">,</span> <span class="n">amount</span><span class="o">,</span> <span class="n">discountAmount</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">IOException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@JsonDeserialize</span><span class="o">(</span><span class="n">using</span> <span class="o">=</span> <span class="nc">EasyPayDtoDeserializer</span><span class="o">.</span><span class="na">class</span><span class="o">)</span> <span class="c1">// 커스텀 변환 적용</span>
<span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">EasyPayDto</span> <span class="o">{</span> <span class="c1">// 간편 결제</span>
	<span class="kd">private</span> <span class="nc">String</span> <span class="n">provider</span><span class="o">;</span> <span class="c1">// 간편결제 제공</span>
	<span class="kd">private</span> <span class="kt">double</span> <span class="n">amount</span><span class="o">;</span> <span class="c1">// 계좌 혹은 현금성 포인트 금액 (충전식 결제 수단)</span>
	<span class="kd">private</span> <span class="kt">double</span> <span class="n">discountAmount</span><span class="o">;</span> <span class="c1">// 적립 포인트, 쿠폰, 즉시 할인된 금액 (적립식 결제수단)</span>
<span class="o">}</span>
</code></pre></div></div>
<p>먼저 EasyPayDtoDeserializer 클래스를 구현하고, Payment 객체 안의 EasyPayDto 객체에 <code class="language-plaintext highlighter-rouge">@JsonDeserialize</code> 애노테이션을 붙여 구현한 클래스와 연결해주면 됩니다.<br />
<br /></p>

<h4 id="jsondeserializer란">JsonDeserializer란?</h4>
<p>JsonDeserializer는 Jackson 라이브러리에서 제공하는 기능으로, JSON 데이터를 특정 Java 객체로 변환하는 과정에서 커스텀 변환 로직을 적용할 수 있도록 도와주는 클래스입니다.<br />
기본적으로 Jackson은 <code class="language-plaintext highlighter-rouge">@JsonProperty</code>나 <code class="language-plaintext highlighter-rouge">@JsonDeserialize</code> 등의 어노테이션을 사용하여 JSON을 Java 객체로 자동 매핑하지만, JSON 데이터의 구조가 예상과 다르거나, 특별한 변환 로직이 필요할 때 JsonDeserializer를 사용합니다.
<br />
<br />
<br /></p>

<h2 id="해외-카드">해외 카드</h2>
<h3 id="참고">참고</h3>
<p>해외 카드 계약을 완료하면 기능 &gt; 카드사 목록에서 해외 카드를 확인할 수 있지만, 저는 해외 결제일 때와 국내 결제일 때를 구분하여 위젯을 노출시키기 때문에 <a href="https://docs.tosspayments.com/guides/v2/learn/foreign-payment">해외결제 연동 API 가이드</a>를 참고했습니다.<br />
해당 가이드 또한 테스트용 해외 카드 번호를 제공하니 참고해서 개발하시면 좋겠습니다.<br />
최근 토스페이먼츠에 해외카드 달러 결제 기능이 추가되었다고 합니다. 하지만 저희 요구사항은 해외카드를 원화 결제이기 때문에 원화로 결제한 코드라는 점 참고해주시기 바랍니다.</p>

<h3 id="준비">준비</h3>
<p>페이팔을 설정해줄 때처럼 결제 UI에서 설정하면 되지만, 다른 점은 커스텀 결제수단 추가에서 이름은 ‘Card’, key는 ‘CARD’로 설정해야 한다는 점입니다. 여기서 설정한 key가 결제위젯 (웹뷰)에서 사용할 키값이라는 것을 기억해두어야 합니다.</p>

<h3 id="trouble-shooting--1">Trouble Shooting 💫</h3>
<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">selectedPaymentMethod</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">paymentMethodWidget</span><span class="p">.</span><span class="nx">getSelectedPaymentMethod</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="nx">selectedPaymentMethod</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">CARD</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// 커스텀 결제 수단에서 추가한 키 값</span>
		<span class="c1">// 해외 카드 결제창 호출</span>
		<span class="kd">const</span> <span class="nx">clientKeyCard</span> <span class="o">=</span> <span class="dl">""</span><span class="p">;</span> <span class="c1">// API 개별 연동 클라이언트 키(해외 카드 MID)</span>
		<span class="kd">const</span> <span class="nx">tossPaymentsCard</span> <span class="o">=</span> <span class="nx">TossPayments</span><span class="p">(</span><span class="nx">clientKeyCard</span><span class="p">);</span>
		<span class="kd">const</span> <span class="nx">customerKey</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">T_NuvKOyhjmLdxNz5SouY</span><span class="dl">"</span><span class="p">;</span>
		<span class="kd">const</span> <span class="nx">payment</span> <span class="o">=</span> <span class="nx">tossPaymentsCard</span><span class="p">.</span><span class="nx">payment</span><span class="p">({</span> <span class="nx">customerKey</span> <span class="p">});</span>
		<span class="nx">payment</span><span class="p">.</span><span class="nx">requestPayment</span><span class="p">({</span>
			<span class="na">method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">CARD</span><span class="dl">"</span><span class="p">,</span> <span class="c1">// 커스텀 결제 수단에서 추가한 키 값</span>
			<span class="na">amount</span><span class="p">:</span> <span class="p">{</span>
				<span class="na">currency</span><span class="p">:</span> <span class="dl">"</span><span class="s2">KRW</span><span class="dl">"</span><span class="p">,</span>
				<span class="na">value</span><span class="p">:</span> <span class="mi">50000</span><span class="p">,</span> <span class="c1">// KRW의 경우 반드시 정수형 타입</span>
			<span class="p">},</span>
			<span class="na">orderId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">mhob2uEy33o616FNnwVpD</span><span class="dl">"</span><span class="p">,</span>
			<span class="na">orderName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">토스 티셔츠 외 2건</span><span class="dl">"</span><span class="p">,</span>
			<span class="na">successUrl</span><span class="p">:</span> <span class="nx">baseUrl</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">/api/reservation/widget/success</span><span class="dl">"</span><span class="p">,</span> <span class="c1">// 추가</span>
			<span class="na">failUrl</span><span class="p">:</span> <span class="nx">baseUrl</span> <span class="o">+</span> <span class="dl">"</span><span class="s2">/api/reservation/widget/fail</span><span class="dl">"</span><span class="p">,</span> <span class="c1">// 추가</span>
			<span class="na">customerEmail</span><span class="p">:</span> <span class="dl">"</span><span class="s2">customer123@gmail.com</span><span class="dl">"</span><span class="p">,</span>
			<span class="na">customerName</span><span class="p">:</span> <span class="dl">"</span><span class="s2">김토스</span><span class="dl">"</span><span class="p">,</span>
			<span class="na">customerMobilePhone</span><span class="p">:</span> <span class="dl">"</span><span class="s2">01012341234</span><span class="dl">"</span><span class="p">,</span>
			<span class="na">card</span><span class="p">:</span> <span class="p">{</span>
				<span class="na">useInternationalCardOnly</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
			<span class="p">},</span>
		<span class="p">});</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Uncaught</span> <span class="p">(</span><span class="k">in</span> <span class="nx">promise</span><span class="p">)</span> <span class="nb">Error</span><span class="p">:</span> <span class="nx">모바일</span> <span class="nx">화면에서는</span> <span class="nb">Promise</span> <span class="nx">방식을</span> <span class="nx">지원하지</span> <span class="nx">않습니다</span><span class="p">.</span>
</code></pre></div></div>
<p>토스에서 제공해준 코드대로 작성해서 시도했더니 위처럼 Promise 방식을 지원하지 않는다는 에러를 마주치게 되었습니다.
그런데 현재 Promise 방식을 사용하지 않았기 때문에, 혹시 몰라서 토스페이먼츠 에러 코드를 찾아보니 뒤에  successUrl, failUrl을 추가하라는 멘트가 있길래 추가해봤습니다.</p>

<p><img src="https://github.com/user-attachments/assets/4121c00e-684f-4a4b-8408-3ed2b47f8068" alt="Image" /></p>

<p>하지만 이렇게 해도 <code class="language-plaintext highlighter-rouge">COMMON_ERROR 처리 중 오류가 발생했습니다</code>라는 에러가 발생했습니다. 이 부분에 대해 토스페이먼츠 디스코드에서 질문하던 중 방법을 찾아냈습니다. 저는 해외결제라고 해서 해외결제 MID를 넣고 있었는데요. 그런데 해외카드에서는 KRW로 결제 처리를 하기 때문에 KRW로 결제하기 위한 MID를 사용해야 했던 것입니다. 당연히 해외카드는 해외결제 관련 키를 사용해야 한다고 생각했는데, 이 부분 때문에 조금 헤맸으니 이걸 보시는 분들은 시간을 아끼시길 바랍니다.
<br />
<br /></p>

<h2 id="alipay">AliPay</h2>
<p>알리페이 또한 해외결제에 해당하지만, Paypal과 달리 비동기로 진행되어 로직을 추가해야 합니다. Paypal의 결제 방식부터 한 번 살펴보겠습니다.</p>

<p><img src="https://github.com/user-attachments/assets/8f8f72a7-c20b-4d8b-ae46-2966394fa54b" alt="Image" />
Paypal은 동기 결제로 우리가 생각하는 흐름처럼 진행됩니다. 결제 위젯에서 결제 정보를 입력하고 ‘결제하기’ 버튼을 누르면 연결된 successUrl/failUrl로 결제 정보가 전달됩니다. successUrl로 전달되었다면 결제 승인 API를 호출하여 결제를 처리하고, 이때 200 응답을 받으면 결제가 성공하게 되는 것입니다.</p>

<p><img src="https://github.com/user-attachments/assets/154c847a-e6c3-4b43-a144-28dd0a0852cd" alt="Image" />
알리페이의 비동기 결제는 무엇이 다를까요? 결제 위젯에서 결제 정보를 입력하고 결제를 요청하는 것까지는 동일하지만 pendingUrl이라는 부분이 생겼습니다. 또한 결제 승인의 결과를 웹훅으로 받아야 합니다.<br />
위에서 중요한 부분이 있습니다. 바로 웹훅이 최대 10분이 걸릴 수 있다는 점입니다. 이를 위해 pendingUrl로 넘어오면 앱에서는 결제 대기 상태라는 것을 알리고, 추후 결제 완료가 되면 다시 알려주겠다는 액션을 취해야 합니다.</p>

<h3 id="구현-팁">구현 팁</h3>

<h4 id="1-pendingurl">1. pendingUrl</h4>
<p>제 상황처럼 앱을 구현하신다면 pendingUrl에서 딥링크를 호출해서 앱으로 돌아갈 수 있도록 구현해주시면 됩니다.</p>

<p><strong>pendingUrl 페이지 예시</strong></p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html</span> <span class="na">lang=</span><span class="s">"ko"</span><span class="nt">&gt;</span>
<span class="nt">&lt;head&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">charset=</span><span class="s">"utf-8"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"icon"</span> <span class="na">href=</span><span class="s">"https://static.toss.im/icons/png/4x/icon-toss-logo.png"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">"stylesheet"</span> <span class="na">href=</span><span class="s">"/css/style.css"</span> <span class="na">type=</span><span class="s">"text/css"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">http-equiv=</span><span class="s">"X-UA-Compatible"</span> <span class="na">content=</span><span class="s">"IE=Chrome"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;meta</span> <span class="na">name=</span><span class="s">"viewport"</span> <span class="na">content=</span><span class="s">"width=device-width, initial-scale=1.0"</span><span class="nt">/&gt;</span>
    <span class="nt">&lt;title&gt;</span>토스페이먼츠 결제 위젯 대기 웹뷰<span class="nt">&lt;/title&gt;</span>
<span class="nt">&lt;/head&gt;</span>
        
<span class="nt">&lt;body&gt;</span>
        
    <span class="nt">&lt;script&gt;</span>
        <span class="k">async</span> <span class="kd">function</span> <span class="nx">confirm</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span> <span class="c1">// app scheme 호출</span>
        <span class="p">}</span>
        <span class="nx">confirm</span><span class="p">();</span>
    <span class="nt">&lt;/script&gt;</span>
        
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
        
</code></pre></div></div>

<h4 id="2-웹훅-등록-및-결제-승인-웹훅-api-추가">2. 웹훅 등록 및 결제 승인 웹훅 API 추가</h4>
<p>웹훅으로 전달받는 결제 승인 결과는 Payment 객체만 전달 받는 게 아니기 때문에 별도로 구현이 필요합니다.
알리페이 또한 간편결제이므로 easyPay라는 필드에 String으로 “알리페이” 혹은 “APLIPAY”라는 값으로 전달되며, status 필드에 따라 결제 성공/실패 분기를 처리해주시면 됩니다.</p>

<p><strong>웹훅 분기 구현 예시</strong><br />
➕ 결제 상태(PaymentStatus)를 미리 enum 클래스로 구현해두었습니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">confirmOrderWebhook</span><span class="o">(</span><span class="nc">OrderWebhookDto</span> <span class="n">webhook</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">TossPaymentDto</span> <span class="n">payment</span> <span class="o">=</span> <span class="n">webhook</span><span class="o">.</span><span class="na">getData</span><span class="o">();</span>
                
    <span class="c1">// 결제 상태에 따른 분기 처리</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">PaymentStatus</span><span class="o">.</span><span class="na">DONE</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">status</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">// 결제 성공 시 로직 구현</span>
    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="nc">PaymentStatus</span><span class="o">.</span><span class="na">ABORTED</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">status</span><span class="o">)</span> 
                <span class="o">||</span> <span class="nc">PaymentStatus</span><span class="o">.</span><span class="na">EXPIRED</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">status</span><span class="o">))</span> <span class="o">{</span>
        <span class="c1">// 결제 실패 시 로직 구현</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="주의">주의</h3>
<ol>
  <li>AWallet이라는 테스트앱이 존재하지만, AWallet에서 결제를 진행해도 pendingUrl로 보내주지 않습니다.</li>
  <li>알리페이 앱에서 pin 번호 인증으로 결제가 성공하면, 현재 서버의 운영에 상관없이 결제가 성공된 것으로 처리합니다.</li>
</ol>

<h3 id="결론">결론</h3>
<p>결과적으로 말하자면 알리페이는 현재 단계에서 적용하지 않게 되었습니다. 테스트 앱에서 결제를 진행(성공/실패)한 것을 앱에서 확인할 수 없고, 라이브 결제 또한 중국에서 생성한 계정만 사용할 수 있어 실제로 사용하기 어렵겠다는 결정이 있었습니다.
<br />
<br /></p>

<h3 id="해외결제-추가-팁️">해외결제 추가 팁❗️</h3>
<ul>
  <li>KRW 결제는 소수점을 지원하지 않으므로, 반드시 정수형 데이터 타입으로 값을 전달해야 합니다.</li>
  <li>Paypal과 해외카드는 실결제 테스트를 할 수 없습니다.
    <ul>
      <li>Paypal은 국내 아이피, 국내 회원가입 계정으로 결제하는 것이 Paypal 정책 및 국내법상 불가능합니다.</li>
      <li>해외카드는 해외에서 발급된 카드를 사용해야 합니다. 국내에서 발급받은 카드 중 VISA, MASTER가 붙은 카드도 국내 카드로 인식됩니다.
<br />
<br />
<br /></li>
    </ul>
  </li>
</ul>

<h3 id="insight--thoughts">insight &amp; thoughts</h3>
<ul>
  <li>이번 해외결제 연동을 진행하면서 예상치 못한 문제들이 있었지만, 해결 과정을 통해 토스페이먼츠의 결제 시스템을 이해할 수 있었습니다.</li>
  <li>특히 Paypal, 해외카드, Alipay의 차이점을 명확히 알게 되었고, 각 결제 방식에 맞는 구현 방식과 주의점을 익혔습니다.</li>
  <li>JsonDeserializer를 활용한 객체와 문자열 처리 방식의 차이를 직접 적용하면서 유연한 데이터 처리 방법을 배운 것도 큰 수확이었습니다.</li>
  <li>해외카드 결제 시 KRW와 USD의 차이를 고려해야 했고, MID 설정 문제로 인해 에러가 발생했지만, 토스페이먼츠 디스코드와 공식 문서를 통해 해결할 수 있었습니다.
    <ul>
      <li>토스페이먼츠 디스코드에서 개발자분들이 친절하게 잘 알려주십니다. 다시 한번 감사드립니다 🙏</li>
    </ul>
  </li>
  <li>Alipay의 경우 비동기 결제 및 웹훅 처리 방식이 Paypal과 다르다는 점이 새로웠고, 이를 구현하는 과정에서 pendingUrl을 활용한 사용자 경험 개선을 고민해야 했습니다.</li>
  <li>Paypal과 해외카드는 국내에서는 실제 테스트가 불가능하여 일부는 이론적인 접근으로 구현해야 했다는 점이 아쉬웠습니다.</li>
  <li>특히 Alipay의 경우, 테스트 환경의 제한으로 인해 실사용이 어려웠다는 점이 아쉽지만, 향후 글로벌 환경에서 적용할 수 있는 기반을 마련한 점은 의미 있다고 생각합니다.</li>
  <li>이번 프로젝트를 통해 해외 결제 시스템의 복잡성을 이해하고, 각 결제 수단의 차이를 명확히 정리할 수 있었던 점이 가장 큰 수확이었습니다. 앞으로 글로벌 서비스를 준비할 때 도움이 될 중요한 경험이 될 것 같습니다!
<br />
<br /></li>
</ul>

<p><strong>참고 자료</strong></p>
<ul>
  <li><a href="https://docs.tosspayments.com/guides/v2/learn/foreign-payment">토스페이먼츠 해외결제 연동하기 가이드</a></li>
  <li><a href="https://docs.tosspayments.com/guides/v2/payment-widget/integration-foreignpay">토스페이먼츠 해외 간편결제 연동하기 가이드</a></li>
  <li><a href="https://docs.tosspayments.com/reference/using-api/webhook-events#payment_status_changed">토스페이먼츠 웹훅 이벤트 가이드</a></li>
  <li><a href="https://www.notion.so/17e714bbfde780b68df9efa1a1667e4a?pvs=21">토스페이먼츠 결제 연동 백서 노션</a>
    <ul>
      <li>해외카드 달러 결제하실 분들 참고하시면 좋겠습니다.</li>
    </ul>
  </li>
</ul>]]></content><author><name>Dajeong Park</name></author><category term="wiki" /><category term="API" /><category term="토스페이먼츠" /><category term="해외결제" /><category term="트러블슈팅" /><category term="Proejct" /><summary type="html"><![CDATA[프로젝트 진행 중 토스페이먼츠를 통해 해외결제를 진행하게 되었는데, 제공해준 가이드가 깔끔하고 구체적이었지만 개인적으로 헤맨 부분이 많아 정리해 볼 겸 작성하게 되었습니다. 해외결제 중 Paypal, 해외카드, Alipay 세 가지를 작업하며 겪은 트러블슈팅까지 작성해두었으니 누군가에게 도움이 되었으면 좋겠습니다.]]></summary></entry><entry><title type="html">JPA Auditing으로 엔티티 변경 이력 관리하기</title><link href="http://localhost:4000/wiki/2025/02/28/jpa-auditing.html" rel="alternate" type="text/html" title="JPA Auditing으로 엔티티 변경 이력 관리하기" /><published>2025-02-28T00:00:00+09:00</published><updated>2025-02-28T00:00:00+09:00</updated><id>http://localhost:4000/wiki/2025/02/28/jpa-auditing</id><content type="html" xml:base="http://localhost:4000/wiki/2025/02/28/jpa-auditing.html"><![CDATA[<p>Spring Data JPA에서는 기본적으로 제공해주는 기능 중 편리한 기능들이 많은데, 그중 내게 충격을 주었던 기능이 바로 Auditing이었다. 
MyBatis에서는 일일이 설정하거나 지정해줘야 했던 부분이 기능으로 있다니.. 
오늘은 JPA Auditing에 대해서 자세히 알아보고, 아직 사용해보지 못한 AuditorAware 기능과 실무에서 겪었던 트러블 슈팅까지 추가해서 기록해두려고 한다.
<br />
<br />
<br /></p>

<h2 id="jpa-auditing">JPA Auditing</h2>
<p>Audit은 사전적으로 ‘감사하다’, ‘단속하다’라는 뜻을 가지고 있다. JPA에서는 Auditing을 제공하여 엔티티가 언제 혹은 누가 생성하거나 변경했는지를 자동으로 추적(단속)하는 기능을 제공한다.
Auditing을 사용하기 위해서는 엔티티 클래스에 Auditing 정보를 포함한 메타데이터를 추가하고, 어노테이션을 사용하거나 특정 인터페이스를 구현하여 정의할 수 있다.
<br />
<br />
<br /></p>

<h2 id="auditing-적용">Auditing 적용</h2>

<h3 id="applicationclass">Application.class</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@EnableJpaAuditing</span>
<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Application</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">CaffeineApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>

</code></pre></div></div>
<p><strong><code class="language-plaintext highlighter-rouge">@EnableJpaAuditing</code></strong></p>
<ul>
  <li>JPA Auditing을 활성하기 위한 어노테이션으로, 이렇게 Application단의 main 메소드에 붙여주거나 Config 클래스를 따로 생성하여 설정해줄 수 있다.</li>
</ul>

<h3 id="basetimeentityclass">BaseTimeEntity.class</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@MappedSuperclass</span>
<span class="nd">@EntityListeners</span><span class="o">(</span><span class="nc">AuditingEntityListener</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">BaseDateTimeEntity</span> <span class="o">{</span>

    <span class="nd">@CreatedDate</span>
    <span class="kd">private</span> <span class="nc">LocalDateTime</span> <span class="n">createdDateTime</span><span class="o">;</span>

    <span class="nd">@LastModifiedDate</span>
    <span class="kd">private</span> <span class="nc">LocalDateTime</span> <span class="n">modifiedDateTime</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p><strong><code class="language-plaintext highlighter-rouge">@MappedSuperclass</code></strong></p>
<ul>
  <li>JPA Entity 클래스들이 BaseTimeEntity 클래스를 상속할 경우 필드들(createdDateTime, modifiedDateTime)을 컬럼으로 인식하도록 한다.</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">@EntityListeners(AuditingEntityListener.class)</code></strong></p>
<ul>
  <li>BaseTimeEntity 클래스에 Auditing 기능을 포함시킨다.</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">@CreatedDate</code></strong></p>
<ul>
  <li>Entity가 생성되어 저장될 때 시간이 자동 저장된다.</li>
</ul>

<p><strong><code class="language-plaintext highlighter-rouge">@LastModifiedDate</code></strong></p>
<ul>
  <li>조회한 Entity의 값을 변경할 때 시간이 자동 저장된다.
<br /></li>
</ul>

<h3 id="-mappedsuperclass란"><strong>➕ @MappedSuperclass란?</strong></h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Documented</span>
<span class="nd">@Target</span><span class="o">(</span><span class="no">TYPE</span><span class="o">)</span>
<span class="nd">@Retention</span><span class="o">(</span><span class="no">RUNTIME</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">MappedSuperclass</span>
</code></pre></div></div>
<ul>
  <li>MappedSuperclass는 상위 클래스로부터 매핑 정보를 상속 받는 클래스임을 지정하는 어노테이션이다.</li>
  <li>지정된 클래스 자체는 별도의 테이블이 생성되지 않는다. (== 상속하는 하위 클래스에만 적용된다.)</li>
  <li>하위 클래스에서는 상속된 매핑 정보가 해당 클래스의 테이블에 적용되고, <code class="language-plaintext highlighter-rouge">@AttributeOverride</code>, <code class="language-plaintext highlighter-rouge">@AssociationOverride</code> 애노테이션 (또는 XML)을 사용하면 매핑 정보를 재정의할 수도 있다.<br />
<br />
<br />
<br /></li>
</ul>

<h2 id="auditoraware">AuditorAware</h2>
<p>그렇다면 AuditorAware는 뭘까? 
아직 직접 써본 적 없지만 생성일, 수정일처럼 생성자, 수정자 같은 사용자 정보도 JPA Auditing을 통해 자동으로 입력해줄 수 있다.
생성일, 수정일과는 구현체를 설정하고 그 구현체를 JWT 같은 인증 토큰을 검사할 때 같이 넣어주면 된다.</p>

<h3 id="userauditawareclass">UserAuditAware.class</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserAuditAware</span> <span class="kd">implements</span> <span class="nc">AuditorAware</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Long</span><span class="o">&gt;</span> <span class="nf">getCurrentAuditor</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">Authentication</span> <span class="n">authentication</span> <span class="o">=</span> <span class="nc">SecurityContextHolder</span><span class="o">.</span><span class="na">getContext</span><span class="o">().</span><span class="na">getAuthentication</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">authentication</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="o">!</span><span class="n">authentication</span><span class="o">.</span><span class="na">isAuthenticated</span><span class="o">())</span> <span class="o">{</span>
            <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
        <span class="o">}</span>

        <span class="nc">CustomUserDetails</span> <span class="n">userDetails</span> <span class="o">=</span> <span class="o">(</span><span class="nc">CustomUserDetails</span><span class="o">)</span> <span class="n">authentication</span><span class="o">.</span><span class="na">getPrincipal</span><span class="o">();</span>
        <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">userDetails</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="applicationclass-1">Application.class</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@EnableJpaAuditing</span><span class="o">(</span><span class="n">auditorAwareRef</span> <span class="o">=</span> <span class="s">"userAuditorAware"</span><span class="o">)</span>
<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Application</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">CaffeineApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>위에서 설정해준 main 메서드에 구현해준 클래스의 빈 이름을 설정해주면 해당 클래스를 이용하여 사용자 정보를 자동으로 등록할 수 있게 된다.<br />
<br />
<br />
<br /></p>

<h2 id="트러블-슈팅-">트러블 슈팅 💫</h2>

<h3 id="어라-왜-update문의-결과를-확인하는데-createddatetime이-null로-업데이트-되지">어라 왜 update문의 결과를 확인하는데 createdDateTime이 null로 업데이트 되지❓🤔</h3>
<p>생성일 컬럼에 이름을 설정하기 위해 <code class="language-plaintext highlighter-rouge">@Column</code> 어노테이션을 붙였는데, <code class="language-plaintext highlighter-rouge">@Column</code>의 옵션 중 하나인 updatable의 기본값이 true라서 값을 설정해주지 않은 생성일 컬럼에 null이 업데이트된 것이다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Target</span><span class="o">({</span><span class="no">METHOD</span><span class="o">,</span> <span class="no">FIELD</span><span class="o">})</span> 
<span class="nd">@Retention</span><span class="o">(</span><span class="no">RUNTIME</span><span class="o">)</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">Column</span> <span class="o">{</span>
	<span class="cm">/**
	* (Optional) Whether the column is included in SQL UPDATE 
	* statements generated by the persistence provider.
	*/</span>
	<span class="kt">boolean</span> <span class="nf">updatable</span><span class="o">()</span> <span class="k">default</span> <span class="o">**</span><span class="kc">true</span><span class="o">**;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>그래서 <code class="language-plaintext highlighter-rouge">@Column</code>을 사용할 거라면 아래처럼 <strong>updatable</strong> 옵션을 <strong>false</strong>로 지정해주는 것이 필요하다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@CreatedDate</span>
<span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"created_date_time"</span><span class="o">,</span> <span class="n">updatable</span> <span class="o">=</span> <span class="kc">false</span><span class="o">)</span>
<span class="kd">private</span> <span class="nc">LocalDateTime</span> <span class="n">createdDateTime</span><span class="o">;</span>
</code></pre></div></div>

<p>다시 생각해보니 <code class="language-plaintext highlighter-rouge">@Column</code> 어노테이션을 꼭 써야할까? 하는 의문이 들었다. 내가 <code class="language-plaintext highlighter-rouge">@Column</code>을 썼던 이유는 Java의 카멜케이스를 데이터베이스의 스네이크케이스와 연결시키고 싶어서였다. 
그런데 아래처럼 YML 파일에 설정하면 자동 연결이 된다니 💦 앞으로는 이런 설정 하나로 코드를 줄이기 위해 한번씩은 꼭 찾아보고 작업할 필요를 느꼈다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">spring:</span>
  <span class="nl">jpa:</span>
    <span class="nl">hibernate:</span>
      <span class="nl">naming:</span>
        <span class="n">physical</span><span class="o">-</span><span class="nl">strategy:</span> <span class="n">org</span><span class="o">.</span><span class="na">hibernate</span><span class="o">.</span><span class="na">boot</span><span class="o">.</span><span class="na">model</span><span class="o">.</span><span class="na">naming</span><span class="o">.</span><span class="na">CamelCaseToUnderscoresNamingStrategy</span>
</code></pre></div></div>

<p>➕ 추가로 <code class="language-plaintext highlighter-rouge">@CreatedDate</code>/<code class="language-plaintext highlighter-rouge">@CreatedBy</code>는 기본적으로 엔티티가 처음 저장될 때 자동으로 값이 설정되지만, 직접 변경하거나 Native Query로는 수정 가능하기 때문에 <code class="language-plaintext highlighter-rouge">@Column(updatable = false)</code>을 설정하는 것이 안전하다.<br />
<br />
<br /></p>

<p><strong>참고</strong></p>
<ul>
  <li><a href="https://docs.spring.io/spring-data/jpa/reference/auditing.html">Spring 공식 문서</a></li>
  <li><a href="https://hudi.blog/spring-data-jpa-auditing-create-update-date/">https://hudi.blog/spring-data-jpa-auditing-create-update-date/</a></li>
</ul>]]></content><author><name>Dajeong Park</name></author><category term="wiki" /><category term="JPA" /><category term="Auditing" /><summary type="html"><![CDATA[Spring Data JPA에서는 기본적으로 제공해주는 기능 중 편리한 기능들이 많은데, 그중 내게 충격을 주었던 기능이 바로 Auditing이었다. MyBatis에서는 일일이 설정하거나 지정해줘야 했던 부분이 기능으로 있다니.. 오늘은 JPA Auditing에 대해서 자세히 알아보고, 아직 사용해보지 못한 AuditorAware 기능과 실무에서 겪었던 트러블 슈팅까지 추가해서 기록해두려고 한다.]]></summary></entry><entry><title type="html">Spring @Scheduled로 간단하게 원하는 시간에 스케줄을 등록해보자</title><link href="http://localhost:4000/wiki/2025/02/13/spring-scheduled-annotation.html" rel="alternate" type="text/html" title="Spring @Scheduled로 간단하게 원하는 시간에 스케줄을 등록해보자" /><published>2025-02-13T00:00:00+09:00</published><updated>2025-02-13T00:00:00+09:00</updated><id>http://localhost:4000/wiki/2025/02/13/spring-scheduled-annotation</id><content type="html" xml:base="http://localhost:4000/wiki/2025/02/13/spring-scheduled-annotation.html"><![CDATA[<p>오늘은 실무에서 자주 사용하는 <code class="language-plaintext highlighter-rouge">@Scheduled</code>에 대해서 정리해두려고 한다. 이번 프로젝트에서도 어김없이 <code class="language-plaintext highlighter-rouge">@Scheduled</code>를 사용하게 되었는데, 마침 이번에 알게 된 부분까지 추가해서 <code class="language-plaintext highlighter-rouge">@Scheduled</code>를 사용하는 방법과 <code class="language-plaintext highlighter-rouge">@Scheduled</code>에서 원하는 시간에 스케줄러를 돌릴 때 사용할 수 있는 Cron식까지 알아보자.
<br />
<br /></p>

<h2 id="scheduled">@Scheduled</h2>
<ul>
  <li><code class="language-plaintext highlighter-rouge">@Scheduled</code>는 Spring에서 제공하는 스케줄링 어노테이션으로, 특정 작업을 일정한 주기로 자동 실행할 수 있도록 도와준다.</li>
  <li>알림 전송, 배치 작업, 데이터 백업 등의 주기적인 작업을 수행해야 할 때 사용할 수 있다.
<br /></li>
</ul>

<h3 id="scheduled-설정">@Scheduled 설정</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@EnableScheduling</span>
<span class="nd">@SpringBootApplication</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SchedulerApplication</span> <span class="o">{</span> 
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>        
		<span class="nc">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="nc">DemoApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>    
	<span class="o">}</span> 
<span class="o">}</span>

</code></pre></div></div>
<ul>
  <li>먼저 Application 클래스 main() 메소드에 <code class="language-plaintext highlighter-rouge">@EnableScheduling</code> 어노테이션을 설정해준다. (Config 클래스를 만들어서 지정하는 것도 가능하다.)
<br /></li>
</ul>

<h3 id="scheduled-사용법">@Scheduled 사용법</h3>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Component</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SchedulerService</span> <span class="o">{</span>
	<span class="nd">@Scheduled</span><span class="o">(</span><span class="n">fixedDelay</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">)</span> <span class="c1">// 1초마다 실행</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"Hello Cron!"</span><span class="o">);</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<ul>
  <li>그러면 이제 메소드에는 <code class="language-plaintext highlighter-rouge">@Scheduled</code> 어노테이션을 붙여 바로 사용할 수 있는데, 주의해야 할 점은 <code class="language-plaintext highlighter-rouge">@Scheduled</code>를 사용할 클래스가 스프링 빈에 등록된 클래스여야 한다는 것이다.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">@Component</code>, <code class="language-plaintext highlighter-rouge">@Service</code> 등
<br /></li>
    </ul>
  </li>
</ul>

<h3 id="scheduled-메소드-규칙">@Scheduled 메소드 규칙</h3>
<ul>
  <li><code class="language-plaintext highlighter-rouge">@Scheduled</code>를 사용하는 메소드는 아래 두 규칙을 지켜야 한다.
    <ol>
      <li>void 리턴 타입</li>
      <li>매개변수 사용 불가
<br />
<br /></li>
    </ol>
  </li>
</ul>

<h2 id="scheduled-속성">@Scheduled 속성</h2>

<h3 id="fixeddelay">fixedDelay</h3>
<ul>
  <li>이전 Task의 종료 시점부터 정의된 시간만큼 지난 후 Task 실행 (단위: milliseconds)</li>
  <li>(작업 수행 시간을 포함하여) <strong>작업을 마친 후부터</strong> 일정 주기마다 메소드 호출</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Scheduled</span><span class="o">(</span><span class="n">fixedDelay</span> <span class="o">=</span> <span class="mi">5000</span><span class="o">)</span> <span class="c1">// 5초마다 실행</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">fixedDelaySchedule</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"FixedDelay Task = {}"</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">0</span><span class="n">초</span> <span class="o">-&gt;</span> <span class="n">실행</span> <span class="o">(</span><span class="mi">3</span><span class="n">초</span> <span class="n">걸림</span><span class="o">,</span> <span class="mi">5</span><span class="n">초</span> <span class="n">대기</span><span class="o">)</span>
<span class="mi">8</span><span class="n">초</span> <span class="o">-&gt;</span> <span class="n">실행</span> <span class="o">(</span><span class="mi">3</span><span class="n">초</span> <span class="n">걸림</span><span class="o">,</span> <span class="mi">5</span><span class="n">초</span> <span class="n">대기</span><span class="o">)</span>
<span class="mi">13</span><span class="n">초</span> <span class="o">-&gt;</span> <span class="n">실행</span>
</code></pre></div></div>

<h3 id="fixedrate">fixedRate</h3>
<ul>
  <li>이전 Task의 시작 시점으로부터 정의된 시간만큼 지난 후 Task 실행 (단위: milliseconds)</li>
  <li><strong>작업 수행시간과 상관없이</strong> 일정 주기마다 메소드 호출</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Scheduled</span><span class="o">(</span><span class="n">fixedRate</span> <span class="o">=</span> <span class="mi">5000</span><span class="o">)</span> <span class="c1">// 5초마다 실행</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">fixedRateSchedule</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"FixedRate Task = {}"</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">0</span><span class="n">초</span> <span class="o">-&gt;</span> <span class="n">실행</span> <span class="o">(</span><span class="mi">3</span><span class="n">초</span> <span class="n">걸림</span><span class="o">)</span>
<span class="mi">5</span><span class="n">초</span> <span class="o">-&gt;</span> <span class="n">실행</span> <span class="o">(</span><span class="mi">3</span><span class="n">초</span> <span class="n">걸림</span><span class="o">)</span>
<span class="mi">10</span><span class="n">초</span> <span class="o">-&gt;</span> <span class="n">실행</span>
</code></pre></div></div>

<h3 id="initialdelay">initialDelay</h3>
<ul>
  <li>애플리케이션 시작 후 초기 지연시간 설정</li>
  <li>서버가 시작되자마자 실행되는 것을 방지</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Scheduled</span><span class="o">(</span><span class="n">fixedRate</span> <span class="o">=</span> <span class="mi">5000</span><span class="o">,</span> <span class="n">initialDelay</span> <span class="o">=</span> <span class="mi">10000</span><span class="o">)</span> <span class="c1">// 5초마다 실행, 초기 10초 대기</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">initialDelaySchedule</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"InitialDelay Task = {}"</span><span class="o">,</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">앱</span> <span class="n">시작</span> <span class="o">-&gt;</span> <span class="mi">10</span><span class="n">초</span> <span class="n">대기</span>
<span class="mi">10</span><span class="n">초</span> <span class="o">-&gt;</span> <span class="n">실행</span>
<span class="mi">15</span><span class="n">초</span> <span class="o">-&gt;</span> <span class="n">실행</span>
<span class="mi">20</span><span class="n">초</span> <span class="o">-&gt;</span> <span class="n">실행</span>
</code></pre></div></div>
<p><br />
<br /></p>

<h2 id="cron">Cron</h2>
<ul>
  <li>일정한 주기가 아니라 특정 시간에 작업을 실행하고 싶다면 cron 속성에 Cron식을 사용하면 된다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Scheduled</span><span class="o">(</span><span class="n">cron</span> <span class="o">=</span> <span class="s">"0 0 10 * * *"</span><span class="o">)</span> <span class="c1">// 매일 오전 10시 실행</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">cronSchedule</span><span class="o">()</span> <span class="o">{</span>
	<span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"Cron Task = {}"</span><span class="o">,</span> <span class="nc">LocalDateTime</span><span class="o">.</span><span class="na">now</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="순서">순서</h3>
<p>1.초(0-59)
2.분(0-59)
3.시간(0-23)
4.일(1-31)
5.월(1-12)
6.요일(0-6) (0:일, … 6: 토)</p>

<h3 id="표현">표현</h3>

<table>
  <thead>
    <tr>
      <th>표현</th>
      <th>설명</th>
      <th>예시</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>*</td>
      <td>모든 조건 (매시, 매일, 매주처럼 사용)</td>
      <td>0 0 18 * * * -&gt; 매일 18시</td>
    </tr>
    <tr>
      <td>?</td>
      <td>설정값 없음 (날짜, 요일에서만 사용 가능)</td>
      <td>0 0 14 10,20 * ? -&gt; 매달 10일, 20일 14시</td>
    </tr>
    <tr>
      <td>-</td>
      <td>범위 지정</td>
      <td>0 0/5 9-18 * * * -&gt; 매일 9시0분에서18시55분 사이에 5분 간격</td>
    </tr>
    <tr>
      <td>,</td>
      <td>여러 값 지정</td>
      <td>0 0 14 10,20 * ? -&gt; 매달 10일, 20일 14시</td>
    </tr>
    <tr>
      <td>/</td>
      <td>증분값, 즉 초기값과 증가치 설정에 사용</td>
      <td>0 0 0/1 * * * -&gt; 1시간마다</td>
    </tr>
    <tr>
      <td>L</td>
      <td>마지막 - 지정할 수 있는 범위의 마지막 값 설정 시 사용 (날짜, 요일에서만 사용 가능)</td>
      <td>0 30 10 ? * 6L -&gt; 매달 마지막 토요일 10시 30분마다</td>
    </tr>
    <tr>
      <td>W</td>
      <td>가장 가까운 평일(weekday) 설정</td>
      <td>10W -&gt; 10일이 평일이면 10일, 주말이면 가까운 평일에 실행</td>
    </tr>
    <tr>
      <td>#</td>
      <td>N번째 주 특정 요일 설정 (요일에서만 사용 가능)</td>
      <td>4#2 → 목요일#둘째주에 실행</td>
    </tr>
  </tbody>
</table>

<p><strong><code class="language-plaintext highlighter-rouge">*</code>와 <code class="language-plaintext highlighter-rouge">?</code>의 차이</strong></p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">?</code>는 특정 값을 지정하지 않음을 의미하는데, <code class="language-plaintext highlighter-rouge">*</code>와 헷갈릴 수 있다.</li>
  <li>예를 들어 <code class="language-plaintext highlighter-rouge">“0 0 12 * * ?”</code>는 매일 12시에 실행하지만, <code class="language-plaintext highlighter-rouge">“0 0 12 * * *”</code>는 매일 12시에 실행하면서 요일도 모든 값에 해당된다는 차이점이 있다.
<br /></li>
</ul>

<h3 id="zone">zone</h3>
<ul>
  <li>cron 표현식에서 사용할 time zone (default: Local time zone)</li>
  <li>서버의 기본 시간대에 의존하면 배포 환경마다 실행 시간이 다를 수 있으므로 zone으로 명확하게 지정해주는 것이 좋다.
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Scheduled</span><span class="o">(</span><span class="n">cron</span> <span class="o">=</span> <span class="err">“</span><span class="mi">0</span> <span class="mi">0</span> <span class="mi">12</span> <span class="o">*</span> <span class="o">*</span> <span class="o">?</span><span class="err">”</span><span class="o">,</span> <span class="n">zone</span> <span class="o">=</span> <span class="s">"Asia/Seoul"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">seoulTimeZoneTask</span><span class="o">()</span> <span class="o">{</span>
  <span class="n">log</span><span class="o">.</span><span class="na">info</span><span class="o">(</span><span class="s">"한국 시간 기준 12시 실행"</span><span class="o">);</span>
<span class="o">}</span>    
</code></pre></div>    </div>
    <p><br />
<br /></p>
  </li>
</ul>

<h2 id="trouble-shooting-">Trouble Shooting 💫</h2>

<h3 id="같은-시간에-두-개의-스케줄러를-설정했는데-왜-하나만-실행될까">같은 시간에 두 개의 스케줄러를 설정했는데 왜 하나만 실행될까❓🤔</h3>
<ul>
  <li><code class="language-plaintext highlighter-rouge">@Scheduled</code>는 기본적으로 <strong>싱글 스레드</strong>에서 실행되므로, 여러 개의 스케줄러를 동시에 실행하려면 application.yml이나 Config 클래스를 사용하여 스레드 풀을 2개 이상으로 설정해야 한다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nl">task:</span>
    <span class="nl">scheduling:</span>
      <span class="nl">pool:</span>
        <span class="nl">size:</span> <span class="mi">5</span>
</code></pre></div></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TaskSchedulerConfig</span> <span class="o">{</span>
    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">TaskScheduler</span> <span class="nf">taskScheduler</span><span class="o">()</span> <span class="o">{</span>
        <span class="nc">ThreadPoolTaskScheduler</span> <span class="n">scheduler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolTaskScheduler</span><span class="o">();</span>
        <span class="n">scheduler</span><span class="o">.</span><span class="na">setPoolSize</span><span class="o">(</span><span class="mi">5</span><span class="o">);</span>
        <span class="n">scheduler</span><span class="o">.</span><span class="na">initialize</span><span class="o">();</span>
        <span class="k">return</span> <span class="n">scheduler</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p><br /></p>

<h3 id="시간마다-말고-한-번만-스케줄러를-실행시킬-수는-없나">시간마다 말고 한 번만 스케줄러를 실행시킬 수는 없나❓🤔</h3>
<ul>
  <li>한 번만 실행되는 스케줄링 작업은 여러 가지가 있지만, 스프링을 사용하고 있다면 TaskScheduler 인터페이스를 구현한 ThreadPoolTaskScheduler를 사용해볼 수 있다.</li>
  <li><code class="language-plaintext highlighter-rouge">@Scheduled</code>처럼 설정만 해주면 멀티 스레드가 가능하고, 대량의 작업을 처리할 수 있다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OneTimeTaskSchedulerService</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">ThreadPoolTaskScheduler</span> <span class="n">taskScheduler</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">OneTimeTaskSchedulerService</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">taskScheduler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadPoolTaskScheduler</span><span class="o">();</span>
        <span class="k">this</span><span class="o">.</span><span class="na">taskScheduler</span><span class="o">.</span><span class="na">initialize</span><span class="o">();</span> <span class="c1">// 초기화 필수</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">scheduleOneTimeTask</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">taskScheduler</span><span class="o">.</span><span class="na">schedule</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"10분 후 실행되는 작업 실행됨! "</span> <span class="o">+</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
            <span class="c1">// 실행할 로직 추가</span>
        <span class="o">},</span> <span class="nc">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">plusSeconds</span><span class="o">(</span><span class="mi">600</span><span class="o">));</span> <span class="c1">// 현재 시간 기준 600초(10분) 후 실행</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>위에서처럼 Config 클래스로 <code class="language-plaintext highlighter-rouge">@Bean</code> 등록을 해준다면 생성자에서 초기화할 필요 없어 코드도 간결하고, 여러 곳에서 사용할 수 있어 더 편리하다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@Service</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OneTimeTaskSchedulerService</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">TaskScheduler</span> <span class="n">taskScheduler</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">scheduleOneTimeTask</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">taskScheduler</span><span class="o">.</span><span class="na">schedule</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"예약된 작업이 실행되었습니다! "</span> <span class="o">+</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">());</span>
            <span class="c1">// 실행할 로직 추가</span>
        <span class="o">},</span> <span class="nc">Instant</span><span class="o">.</span><span class="na">now</span><span class="o">().</span><span class="na">plusSeconds</span><span class="o">(</span><span class="mi">600</span><span class="o">));</span> <span class="c1">// 현재 시간 기준 600초(10분) 후 실행</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p><br />
<br /></p>

<p><strong>참고</strong></p>
<ul>
  <li><a href="https://spring.io/guides/gs/scheduling-tasks">Spring 공식 가이드</a></li>
  <li><a href="https://dev-coco.tistory.com/176">https://dev-coco.tistory.com/176</a></li>
  <li><a href="https://data-make.tistory.com/699">https://data-make.tistory.com/699</a></li>
  <li><a href="https://chatgpt.com/c/67ac8d2b-83d0-8003-98ec-3ffc372b8437">https://chatgpt.com/c/67ac8d2b-83d0-8003-98ec-3ffc372b8437</a></li>
</ul>]]></content><author><name>Dajeong Park</name></author><category term="wiki" /><category term="Spring" /><category term="Scheduled" /><category term="TaskScheduler" /><category term="Annotation" /><summary type="html"><![CDATA[오늘은 실무에서 자주 사용하는 @Scheduled에 대해서 정리해두려고 한다. 이번 프로젝트에서도 어김없이 @Scheduled를 사용하게 되었는데, 마침 이번에 알게 된 부분까지 추가해서 @Scheduled를 사용하는 방법과 @Scheduled에서 원하는 시간에 스케줄러를 돌릴 때 사용할 수 있는 Cron식까지 알아보자.]]></summary></entry><entry><title type="html">QueryDSL에서 FROM 절에 서브쿼리를 넣어보자 (feat. @Subselect)</title><link href="http://localhost:4000/wiki/2025/01/31/querydsl-subselect.html" rel="alternate" type="text/html" title="QueryDSL에서 FROM 절에 서브쿼리를 넣어보자 (feat. @Subselect)" /><published>2025-01-31T00:00:00+09:00</published><updated>2025-01-31T00:00:00+09:00</updated><id>http://localhost:4000/wiki/2025/01/31/querydsl-subselect</id><content type="html" xml:base="http://localhost:4000/wiki/2025/01/31/querydsl-subselect.html"><![CDATA[<p>현재 진행하는 프로젝트에서 쿠폰 관련 복잡한 쿼리를 작성하던 중이었다. 
SQL로 먼저 작업을 해보는데 서브쿼리를 from 절에 넣어야 데이터가 제대로 나오는데, QueryDSL에서는 from 절에 서브쿼리를 넣을 수 없다는 문제를 있었다.
그래서 해결 방법을 찾아보다가 <code class="language-plaintext highlighter-rouge">@Subselect</code>라는 Hibernate 기능을 사용하면 쿼리를 캡슐화해서 View를 만들어 엔티티처럼 사용할 수 있다는 걸 알게 되었다.
그래서 @Subselect를 활용하여 서브쿼리를 효과적으로 사용하는 방법을 공유하려고 한다.</p>

<p><img width="743" alt="Image" src="https://github.com/user-attachments/assets/8d09e978-f260-4342-905f-fa789ffb653f" />
<br />
<br /></p>

<h3 id="서브쿼리로-사용할-클래스-선언">서브쿼리로 사용할 클래스 선언</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Subselect</span><span class="o">(</span>
        <span class="s">"select c.id, ROW_NUMBER() OVER (ORDER BY cd.valid_end_date ASC) as rn "</span> <span class="o">+</span>
                <span class="s">"from coupons c "</span> <span class="o">+</span>
                <span class="s">"inner join coupon_duration_settings cd on c.id = cd.coupon_id "</span> <span class="o">+</span>
                <span class="s">"where c.discount_type = 'RATE' "</span> <span class="o">+</span>
                    <span class="s">"and c.discount_value = ("</span> <span class="o">+</span>
                        <span class="s">"select max(c2.discount_value) "</span> <span class="o">+</span>
                        <span class="s">"from coupons c2 "</span> <span class="o">+</span>
                        <span class="s">"where c2.discount_type = 'RATE'"</span> <span class="o">+</span>
                    <span class="s">")"</span>
<span class="o">)</span>
<span class="nd">@Immutable</span>
<span class="nd">@Synchronize</span><span class="o">(</span><span class="s">"coupons"</span><span class="o">)</span>
<span class="nd">@NoArgsConstructor</span>
<span class="nd">@AllArgsConstructor</span>
<span class="nd">@Entity</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MaxRateCouponSubDto</span> <span class="o">{</span>

    <span class="nd">@Id</span>
    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"id"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Long</span> <span class="n">id</span><span class="o">;</span>

    <span class="nd">@Column</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"rn"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="kt">long</span> <span class="n">rn</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>select문에서 사용한 컬럼명과 필드에 <code class="language-plaintext highlighter-rouge">@Column</code> 애노테이션으로 설정해준 name이 동일해야 찾을 수 있다.</li>
  <li><code class="language-plaintext highlighter-rouge">@Subselect</code>를 사용한 엔티티는 어떤 특정 엔티티에 종속된 것이 아니기 때문에 <code class="language-plaintext highlighter-rouge">@Immutable</code>을 선언해주어야 하여 불변(<strong>immutable</strong>), 즉 읽기 전용으로 변경 불가함을 선언해야 한다.
    <ul>
      <li><code class="language-plaintext highlighter-rouge">@Immutable</code> : 해당 엔티티가 변경되지 않는 데이터임을 Hibernate에게 알려주는 애노테이션으로, 변경 감지를 방지하여 성능을 최적화할 수 있다.  <br />
<img width="1003" alt="Image" src="https://github.com/user-attachments/assets/f033f851-4c23-4c52-b86e-e4f52c9e5f45" /></li>
    </ul>
  </li>
  <li>또한, 동시성 문제를 제어하여 데이터의 일관성을 보장하기 위해 <code class="language-plaintext highlighter-rouge">@Sychronize</code>을 사용했다.
<br />
<br /></li>
</ul>

<h3 id="querydsl에서-사용">QueryDSL에서 사용</h3>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">QMaxRateCouponSubDto</span> <span class="n">maxRateCouponSub</span> <span class="o">=</span> <span class="nc">QMaxRateCouponSubDto</span><span class="o">.</span><span class="na">maxRateCouponSubDto</span><span class="o">;</span>
<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">QMaxAmountCouponSubDto</span> <span class="n">maxAmountCouponSub</span> <span class="o">=</span> <span class="nc">QMaxAmountCouponSubDto</span><span class="o">.</span><span class="na">maxAmountCouponSubDto</span><span class="o">;</span>

<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">HotelAndCouponResponse</span><span class="o">&gt;</span> <span class="nf">findHotelAndCoupons</span><span class="o">(</span><span class="nc">HotelSearchConditionDto</span> <span class="n">condition</span><span class="o">)</span> <span class="o">{</span>
 <span class="nc">BooleanBuilder</span> <span class="n">whereClause</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BooleanBuilder</span><span class="o">();</span>
 <span class="o">...</span> 
 <span class="k">return</span> <span class="n">queryFactory</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="nc">Projections</span><span class="o">.</span><span class="na">constructor</span><span class="o">(</span><span class="nc">HotelAndCouponResponse</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                        <span class="n">hotel</span><span class="o">.</span><span class="na">id</span><span class="o">,</span>
                        <span class="nc">Projections</span><span class="o">.</span><span class="na">constructor</span><span class="o">(</span><span class="nc">CouponDto</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                                <span class="n">rateCouponDuration</span><span class="o">.</span><span class="na">isTimeDeal</span><span class="o">.</span><span class="na">stringValue</span><span class="o">().</span><span class="na">max</span><span class="o">(),</span>
                                <span class="n">rateCouponDuration</span><span class="o">.</span><span class="na">validStartDate</span><span class="o">.</span><span class="na">max</span><span class="o">(),</span>
                                <span class="n">rateCouponDuration</span><span class="o">.</span><span class="na">validEndDate</span><span class="o">.</span><span class="na">max</span><span class="o">(),</span>
                                <span class="n">rateCoupon</span><span class="o">.</span><span class="na">discountType</span><span class="o">.</span><span class="na">max</span><span class="o">(),</span>
                                <span class="n">rateCoupon</span><span class="o">.</span><span class="na">discountValue</span><span class="o">.</span><span class="na">max</span><span class="o">(),</span>
                                <span class="n">rateCoupon</span><span class="o">.</span><span class="na">maxDiscountPrice</span><span class="o">.</span><span class="na">max</span><span class="o">()</span>
                        <span class="o">),</span>
                        <span class="nc">Projections</span><span class="o">.</span><span class="na">constructor</span><span class="o">(</span><span class="nc">CouponDto</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
                                <span class="n">amountCouponDuration</span><span class="o">.</span><span class="na">isTimeDeal</span><span class="o">.</span><span class="na">stringValue</span><span class="o">().</span><span class="na">max</span><span class="o">(),</span>
                                <span class="n">amountCouponDuration</span><span class="o">.</span><span class="na">validStartDate</span><span class="o">.</span><span class="na">max</span><span class="o">(),</span>
                                <span class="n">amountCouponDuration</span><span class="o">.</span><span class="na">validEndDate</span><span class="o">.</span><span class="na">max</span><span class="o">(),</span>
                                <span class="n">amountCoupon</span><span class="o">.</span><span class="na">discountType</span><span class="o">.</span><span class="na">max</span><span class="o">(),</span>
                                <span class="n">amountCoupon</span><span class="o">.</span><span class="na">discountValue</span><span class="o">.</span><span class="na">max</span><span class="o">(),</span>
                                <span class="n">amountCoupon</span><span class="o">.</span><span class="na">maxDiscountPrice</span><span class="o">.</span><span class="na">max</span><span class="o">()</span>
                        <span class="o">)</span>
                <span class="o">))</span>
                <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">hotel</span><span class="o">)</span>
                <span class="o">.</span><span class="na">leftJoin</span><span class="o">(</span><span class="n">couponUsageConditionObject</span><span class="o">).</span><span class="na">on</span><span class="o">(</span><span class="n">couponUsageConditionObject</span><span class="o">.</span><span class="na">hotel</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="n">hotel</span><span class="o">.</span><span class="na">id</span><span class="o">))</span>
                <span class="o">.</span><span class="na">leftJoin</span><span class="o">(</span><span class="n">rateCoupon</span><span class="o">).</span><span class="na">on</span><span class="o">(</span><span class="n">rateCoupon</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="n">couponUsageConditionObject</span><span class="o">.</span><span class="na">coupon</span><span class="o">.</span><span class="na">id</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">rateCoupon</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span>
                                <span class="nc">JPAExpressions</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">maxRateCouponSub</span><span class="o">.</span><span class="na">id</span><span class="o">)</span>
                                        <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">maxRateCouponSub</span><span class="o">)</span>
                                        <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">maxRateCouponSub</span><span class="o">.</span><span class="na">rn</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="mi">1L</span><span class="o">))</span>
                        <span class="o">)))</span>
                <span class="o">.</span><span class="na">leftJoin</span><span class="o">(</span><span class="n">rateCouponDuration</span><span class="o">).</span><span class="na">on</span><span class="o">(</span><span class="n">rateCouponDuration</span><span class="o">.</span><span class="na">coupon</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="n">rateCoupon</span><span class="o">.</span><span class="na">id</span><span class="o">))</span>
                <span class="o">.</span><span class="na">leftJoin</span><span class="o">(</span><span class="n">amountCoupon</span><span class="o">).</span><span class="na">on</span><span class="o">(</span><span class="n">amountCoupon</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="n">couponUsageConditionObject</span><span class="o">.</span><span class="na">coupon</span><span class="o">.</span><span class="na">id</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">and</span><span class="o">(</span><span class="n">amountCoupon</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span>
                                <span class="nc">JPAExpressions</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">maxAmountCouponSub</span><span class="o">.</span><span class="na">id</span><span class="o">)</span>
                                        <span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">maxAmountCouponSub</span><span class="o">)</span>
                                        <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">maxAmountCouponSub</span><span class="o">.</span><span class="na">rn</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="mi">1L</span><span class="o">))</span>
                        <span class="o">)))</span>
                <span class="o">.</span><span class="na">leftJoin</span><span class="o">(</span><span class="n">amountCouponDuration</span><span class="o">).</span><span class="na">on</span><span class="o">(</span><span class="n">amountCouponDuration</span><span class="o">.</span><span class="na">coupon</span><span class="o">.</span><span class="na">id</span><span class="o">.</span><span class="na">eq</span><span class="o">(</span><span class="n">amountCoupon</span><span class="o">.</span><span class="na">id</span><span class="o">))</span>
                <span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">whereClause</span><span class="o">)</span>
                <span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="n">hotel</span><span class="o">.</span><span class="na">id</span><span class="o">)</span>
                <span class="o">.</span><span class="na">fetch</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li>위에서 생성해준 클래스를 Q클래스로 선언하고, from 절에 넣어 사용하면 <code class="language-plaintext highlighter-rouge">@Subselect</code>에 작성한 코드가 그대로 서브쿼리로 들어간다.</li>
</ul>

<p><strong>SQL 예시</strong></p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="n">h</span><span class="p">.</span><span class="n">id</span><span class="p">,</span>
       <span class="k">MAX</span><span class="p">(</span><span class="n">rcd</span><span class="p">.</span><span class="n">is_time_deal</span><span class="p">),</span>
       <span class="k">MAX</span><span class="p">(</span><span class="n">rcd</span><span class="p">.</span><span class="n">valid_start_date</span><span class="p">),</span>
       <span class="k">MAX</span><span class="p">(</span><span class="n">rcd</span><span class="p">.</span><span class="n">valid_end_date</span><span class="p">),</span>
       <span class="k">MAX</span><span class="p">(</span><span class="n">rc</span><span class="p">.</span><span class="n">discount_type</span><span class="p">),</span>
       <span class="k">MAX</span><span class="p">(</span><span class="n">rc</span><span class="p">.</span><span class="n">discount_value</span><span class="p">),</span>
       <span class="k">MAX</span><span class="p">(</span><span class="n">rc</span><span class="p">.</span><span class="n">max_discount_price</span><span class="p">),</span>
       <span class="k">MAX</span><span class="p">(</span><span class="n">acd</span><span class="p">.</span><span class="n">is_time_deal</span><span class="p">),</span>
       <span class="k">MAX</span><span class="p">(</span><span class="n">acd</span><span class="p">.</span><span class="n">valid_start_date</span><span class="p">),</span>
       <span class="k">MAX</span><span class="p">(</span><span class="n">acd</span><span class="p">.</span><span class="n">valid_end_date</span><span class="p">),</span>
       <span class="k">MAX</span><span class="p">(</span><span class="n">ac</span><span class="p">.</span><span class="n">discount_type</span><span class="p">),</span>
       <span class="k">MAX</span><span class="p">(</span><span class="n">ac</span><span class="p">.</span><span class="n">discount_value</span><span class="p">),</span>
       <span class="k">MAX</span><span class="p">(</span><span class="n">ac</span><span class="p">.</span><span class="n">max_discount_price</span><span class="p">)</span>
<span class="k">FROM</span> <span class="n">hotels</span> <span class="n">h</span>
         <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">coupon_usage_conditions</span> <span class="n">cuc</span>
                   <span class="k">ON</span> <span class="n">cuc</span><span class="p">.</span><span class="n">hotel_id</span> <span class="o">=</span> <span class="n">h</span><span class="p">.</span><span class="n">id</span>
         <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">rate_coupons</span> <span class="n">rc</span>
                   <span class="k">ON</span> <span class="n">rc</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">cuc</span><span class="p">.</span><span class="n">coupon_id</span>
                       <span class="k">AND</span> <span class="n">rc</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="p">(</span>
                           <span class="k">SELECT</span> <span class="n">mrt</span><span class="p">.</span><span class="n">id</span>
                           <span class="k">FROM</span> <span class="p">(</span>
                                    <span class="k">select</span> <span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">ROW_NUMBER</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">cd</span><span class="p">.</span><span class="n">valid_end_date</span> <span class="k">ASC</span><span class="p">)</span> <span class="k">as</span> <span class="n">rn</span>
                                    <span class="k">from</span> <span class="n">coupons</span> <span class="k">c</span>
                                             <span class="k">inner</span> <span class="k">join</span> <span class="n">coupon_duration_settings</span> <span class="n">cd</span> <span class="k">on</span> <span class="k">c</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">cd</span><span class="p">.</span><span class="n">coupon_id</span>
                                    <span class="k">where</span> <span class="k">c</span><span class="p">.</span><span class="n">discount_type</span> <span class="o">=</span> <span class="s1">'RATE'</span>
                                      <span class="k">and</span> <span class="k">c</span><span class="p">.</span><span class="n">discount_value</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="k">select</span> <span class="k">max</span><span class="p">(</span><span class="n">c2</span><span class="p">.</span><span class="n">discount_value</span><span class="p">)</span>
                                        <span class="k">from</span> <span class="n">coupons</span> <span class="n">c2</span>
                                        <span class="k">where</span> <span class="n">c2</span><span class="p">.</span><span class="n">discount_type</span> <span class="o">=</span> <span class="s1">'RATE'</span>
                                    <span class="p">)</span>
                                <span class="p">)</span> <span class="n">mrt</span>
                           <span class="k">WHERE</span> <span class="n">mrt</span><span class="p">.</span><span class="n">rn</span> <span class="o">=</span> <span class="mi">1</span>
                       <span class="p">)</span>
         <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">rate_coupon_durations</span> <span class="n">rcd</span>
                   <span class="k">ON</span> <span class="n">rcd</span><span class="p">.</span><span class="n">coupon_id</span> <span class="o">=</span> <span class="n">rc</span><span class="p">.</span><span class="n">id</span>
         <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">amount_coupons</span> <span class="n">ac</span>
                   <span class="k">ON</span> <span class="n">ac</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">cuc</span><span class="p">.</span><span class="n">coupon_id</span>
                       <span class="k">AND</span> <span class="n">ac</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="p">(</span>
                           <span class="k">SELECT</span> <span class="n">mac</span><span class="p">.</span><span class="n">id</span>
                           <span class="k">FROM</span> <span class="p">(</span>
                                    <span class="k">select</span> <span class="n">c3</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">ROW_NUMBER</span><span class="p">()</span> <span class="n">OVER</span> <span class="p">(</span><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">cd2</span><span class="p">.</span><span class="n">valid_end_date</span> <span class="k">ASC</span><span class="p">)</span> <span class="k">as</span> <span class="n">rn</span>
                                    <span class="k">from</span> <span class="n">coupons</span> <span class="n">c3</span>
                                             <span class="k">inner</span> <span class="k">join</span> <span class="n">coupon_duration_settings</span> <span class="n">cd2</span> <span class="k">on</span> <span class="n">c3</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">cd2</span><span class="p">.</span><span class="n">coupon_id</span>
                                    <span class="k">where</span> <span class="n">c3</span><span class="p">.</span><span class="n">discount_type</span> <span class="o">=</span> <span class="s1">'AMOUNT'</span>
                                      <span class="k">and</span> <span class="n">c3</span><span class="p">.</span><span class="n">discount_value</span> <span class="o">=</span> <span class="p">(</span>
                                        <span class="k">select</span> <span class="k">max</span><span class="p">(</span><span class="n">c4</span><span class="p">.</span><span class="n">discount_value</span><span class="p">)</span>
                                        <span class="k">from</span> <span class="n">coupons</span> <span class="n">c4</span>
                                        <span class="k">where</span> <span class="n">c4</span><span class="p">.</span><span class="n">discount_type</span> <span class="o">=</span> <span class="s1">'AMOUNT'</span>
                                    <span class="p">)</span>
                                <span class="p">)</span> <span class="n">mac</span>
                           <span class="k">WHERE</span> <span class="n">mac</span><span class="p">.</span><span class="n">rn</span> <span class="o">=</span> <span class="mi">1</span>
                       <span class="p">)</span>
         <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">amount_coupon_durations</span> <span class="n">acd</span>
                   <span class="k">ON</span> <span class="n">acd</span><span class="p">.</span><span class="n">coupon_id</span> <span class="o">=</span> <span class="n">ac</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span> <span class="n">h</span><span class="p">.</span><span class="n">has_deleted</span> <span class="o">=</span> <span class="k">false</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">h</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>

</code></pre></div></div>
<p><br />
<br /></p>

<h3 id="장점">장점</h3>
<ul>
  <li>중복으로 여러 곳에서 사용할 경우 하나의 클래스로 두는 것이 가독성이나 유지보수면에서 좋다.</li>
  <li><strong>읽기 전용(<code class="language-plaintext highlighter-rouge">immutable</code>)</strong>이기 때문에 불필요하게 엔티티를 저장 및 수정하지 않고 데이터의 일관성을 유지할 수 있다.</li>
  <li>기존 테이블(여기선 coupons)를 변경하지 않고 새로운 엔티티를 정의하여 사용할 수 있다.</li>
  <li><code class="language-plaintext highlighter-rouge">@Subselect</code>는 서브쿼리를 가상의 엔티티로 매핑하는 방식이므로, ORM이 이를 단순한 조회로 처리하기 때문에 복잡한 조인 쿼리보다 성능이 더 나을 수 있다.
<br /></li>
</ul>

<h3 id="단점">단점</h3>
<ul>
  <li><code class="language-plaintext highlighter-rouge">@Subselect</code> 문 안의 쿼리에 동적으로 쿼리를 추가할 수 없다. (제일 아쉬운 부분)</li>
  <li>쿼리가 복잡한 경우 <strong>성능 저하</strong>를 유발할 수 있다.</li>
  <li>View는 실제 데이터가 존재하지 않기 때문에 <strong>조회만 가능</strong>하다.
<br />
<br /></li>
</ul>

<h3 id="insight">insight</h3>
<p>이번 작업을 통해 QueryDSL에서 FROM 절의 서브쿼리 문제를 해결하는 다양한 방법을 고민할 수 있었다.
처음에는 단순히 JPAExpressions로 해결하려 했지만, 쿠폰처럼 여러 곳에서 중복으로 사용할 경우 성능과 유지보수를 고려할 때 이렇게 @Subselect를 붙인 엔티티를 사용하는 게 더 적절하다는 결론을 냈다.
다행히 쿼리도 기존보다 느려지지 않아서 좋았지만, 이런 상황에서 동적 쿼리가 필요하다면 어떻게 해야 하는지 알아볼 필요가 있다.
<br />
<br />
<br /></p>

<p><strong>참고</strong></p>
<ul>
  <li><a href="https://www.baeldung.com/hibernate-subselect">@Subselect Annotation in Hibernate</a></li>
  <li><a href="https://juu-code.tistory.com/49">JPA 에서 From 절에 서브쿼리 쓰기(@Subselect 통해서 view 생성)</a></li>
</ul>]]></content><author><name>Dajeong Park</name></author><category term="wiki" /><category term="Java" /><category term="SpringBoot" /><category term="JPA" /><category term="QueryDSL" /><category term="Subselect" /><summary type="html"><![CDATA[현재 진행하는 프로젝트에서 쿠폰 관련 복잡한 쿼리를 작성하던 중이었다. SQL로 먼저 작업을 해보는데 서브쿼리를 from 절에 넣어야 데이터가 제대로 나오는데, QueryDSL에서는 from 절에 서브쿼리를 넣을 수 없다는 문제를 있었다. 그래서 해결 방법을 찾아보다가 @Subselect라는 Hibernate 기능을 사용하면 쿼리를 캡슐화해서 View를 만들어 엔티티처럼 사용할 수 있다는 걸 알게 되었다. 그래서 @Subselect를 활용하여 서브쿼리를 효과적으로 사용하는 방법을 공유하려고 한다.]]></summary></entry><entry><title type="html">작지만 확실한 성장기 - 2024 회고와 2025 목표</title><link href="http://localhost:4000/blog/2025/01/18/review-2024-and-2025.html" rel="alternate" type="text/html" title="작지만 확실한 성장기 - 2024 회고와 2025 목표" /><published>2025-01-18T00:00:00+09:00</published><updated>2025-01-18T00:00:00+09:00</updated><id>http://localhost:4000/blog/2025/01/18/review-2024-and-2025</id><content type="html" xml:base="http://localhost:4000/blog/2025/01/18/review-2024-and-2025.html"><![CDATA[<p><img alt="swagger-ui-group-setting" src="https://github.com/user-attachments/assets/bff0e492-715e-4534-a209-03fcacf10494" />
<br />
<br /></p>

<h2 id="2024-회고">2024 회고</h2>

<h3 id="잘한-점">잘한 점</h3>

<h4 id="인턴">인턴</h4>
<p>2023년까지는 공백기와 여러 가지 이유로 개발자라는 직업에 대해 회의감이 많이 들었습니다. 그래서 다음 회사에서도 이 직업을 해야 하는 이유에 대해서 찾지 못한다면 다른 직업을 찾아봐야겠다고 생각했었죠. 그렇게 입사하게 된 회사에서 다행히 좋은 팀원들을 만났습니다. 저보다 열정적이고 똑똑한 팀원들 덕분에 클린 아키텍처와 AWS 관련해서 흥미를 갖게 되었고, 개발 컨벤션이나 Jira에 대해서도 배웠습니다. 그 때 두 분 덕분에 제가 개발자로 후회없이 해보고 싶은 마음을 갖게 되어 아직도 감사하고 있습니다.
 <br /></p>

<h4 id="포텐데이와-공모전-참가">포텐데이와 공모전 참가</h4>
<p>인턴 이후 마땅히 취업 때 보여드릴 코드가 없다고 생각해 사이드 프로젝트를 구하고 있었는데요. 그때 마침 눈에 들어온 게 포텐데이였습니다. 포텐데이는 기획자, 디자이너, 프론트/백엔드 개발자가 10일간 개발하는 해커톤입니다. 포텐데이를 진행하면서 특히 같은 백엔드분께 이런저런 기능을 왜 사용해야 하는지 설명해주면서 개인적으로 많이 성장할 수 있었습니다. 프로젝트와 서버 세팅 등 주니어가 경험하기 힘든 작업을 주도적으로 진행하면서 백엔드가 하는 직무에 대해서도 많이 흥미를 느끼는 계기가 되었습니다.
 <br /></p>

<h4 id="국민취업지원제도">국민취업지원제도</h4>
<p>2024년에는 제 자신에 대해 제대로 파악해서 취업하고 싶었습니다. 그래서 지인이 경험해보고 괜찮다고 한 국민취업지원제도를 통해 이력서, 자기소개서에 대해 첨삭도 받고 연결 받은 곳을 통해 취업도 할 수 있었습니다. 이 과정에서 인프런 이력서 강의의 강사님께 첨삭도 받아봤는데, 정말 도움이 많이 되어서 저도 강사님처럼 다른 개발자분들께 도움이 되고 싶다는 생각도 하게 되었습니다.
 <br /></p>

<h4 id="취업">취업</h4>
<p>무엇이든 경험해보는 게 목표였기 때문에 가리지 않고 지원한 결과 SI 회사에 입사하게 되었습니다. 현재  회사는 SI보다는 에이전시의 성격을 가지고 있는데요, 그래서인지 프로젝트마다 많은 걸 경험하고 있습니다.<br />
입사한지 반 년 정도 된 지금, 생각보다 다양한 기능을 작업해봤는데요. 결제 작업이 되어있는 기존 프로젝트에 정기결제를 하는 작업도 해보고, 현재 프로젝트에서는 토스페이먼츠 연동, 다국어 처리, 오픈 API를 통한 달러 조회, 센드버드 등 새로운 기능을 경험해봤습니다. 이에 대해서는 차차 블로그에 글로 기록해보도록 하겠습니다.
 <br /></p>

<h4 id="글또">글또</h4>
<p>개발에 대한 동기부여를 얻기 위해 글또에 참여했는데요. 역시나 열심히 하시는 글또분들 덕분에 그래도 하반기에 조금이나마 열심히 블로그 글을 써볼 수 있었습니다.
 <br /></p>

<h3 id="아쉬운-점">아쉬운 점</h3>
<h4 id="취직-이후-개발-공부">취직 이후 개발 공부</h4>
<p>입사 후 적응도 하고 야근하느라 바빠 개발 공부에 소홀했습니다. 목표로 두었던 테스트코드 강의도 완강하지 못했네요 🥹
 <br /></p>
<h4 id="글또-참여율">글또 참여율</h4>
<p>초반 튜링의 사과에서 방문해서 커피챗을 한 것 이외에 오프라인 참여가 아무것도 없다니… 정말 너무 아쉽네요.. 다른 모임에서도 뭔가 활발히 활동하지 않은 것 같습니다..
 <br />
  <br /></p>

<h2 id="2025-목표와-다짐">2025 목표와 다짐</h2>

<h3 id="목표">목표</h3>

<h4 id="글또-참여율-높이기">글또 참여율 높이기</h4>
<p>2024년 아쉬움에 썼던 대로 앞으로 후회하지 않기 위해서 남은 기간은 글또에 매일 방문해보려고 합니다. 또한, 튜링의 사과에도 2주에 한번 방문해서 커피챗의 기회도 많이 늘려보겠습니다. 파이팅!</p>
<h4 id="꾸준히-글쓰기">꾸준히 글쓰기</h4>
<p>글또가 끝나도 한 달에 2번 이상 글 쓰는 게 목표입니다. 주 1회가 가장 이상적이지만, 천천히 늘려보겠습니다.</p>
<h4 id="트러블슈팅-바로바로">트러블슈팅 바로바로</h4>
<p>이번 프로젝트부터는 일하기 바빠 트러블슈팅을 바로 하지 않았더니 열심히 해결한 문제도 제대로 기억나지 않더라구요. 앞으로는 트러블슈팅도 업무의 일환으로 생각하여 최대 일주일 안에 정리해서 작성해보려고 합니다.</p>
<h4 id="테스트-코드-등으로-역량-넓히기">테스트 코드 등으로 역량 넓히기</h4>
<p>올해야말로 테스트 코드를 정복해야 할 때라고 생각합니다. 회사에서는 구매해주신 강의를 통해 차근차근 연습해보려고 합니다. 이번 달 안에 박우빈님의 ‘Practical Testing: 실용적인 테스트 가이드’를 완강하고, 다음 달에는 글또 대나무숲에서 추천해주셨던 테스트 강의를 구매해서 수강해보겠습니다. 이외에도 역량을 넓히기 위해 성능 테스트 등 몇 가지를 도전해보겠습니다.</p>
<h4 id="코딩테스트-관련-공부">코딩테스트 관련 공부</h4>
<p>더 이상 미룰 수 없다.. 코딩테스트 관련 공부를 항상 미뤄왔는데요. 이제 더 이상은 안되겠습니다.. 다시 하루에 한 개씩 풀겠다는 목표를 세웠는데, 마침 글또에도 하루에 한 문제씩 풀어서 인증하는 채널이 있더라구요! 저도 한 번 조인해보겠습니다 👍</p>
<h4 id="질-좋은-의사소통">질 좋은 의사소통</h4>
<p>어느덧 3년차.. 조금씩 연차가 찰 수록 드는 생각은 “개발자에게 코드만큼 중요한 게 의사소통이다”라는 건데요. 요즘 뼈저리게 느끼고 있는 만큼 좋은 의사소통에 대해 고민하고 개선해 볼 생각입니다.</p>
<h4 id="준비된-체력">준비된 체력</h4>
<p>작년 취업 준비 기간을 운동으로 잘 버텼던 만큼 올해에는 PT를 통해 체력과 집중력 모두 잡아보려고 합니다. 다음달에 마라톤도 나가기로 했으니 기대 많이 해주시라,,,</p>
<h4 id="도파민-줄이기">도파민 줄이기</h4>
<p>출퇴근 길에도 무의미하게 게임하고 유튜브 쇼츠도 너무 무방비하게 보는 것을 막고자 게임도 지우고 유튜브 프리미엄을 해지해보려고 합니다. 계속 되길 바라며, 도파민 대신 책 읽고 출근길에는 말해보카로 영어 공부를 하며 좋은 습관을 다시 들여보겠습니다.
<br /></p>

<h3 id="마음가짐">마음가짐</h3>
<ul>
  <li>무엇이든 후회없이 해보기 (<strong>일단 해!</strong>)</li>
  <li>긍정적으로 생각하기</li>
</ul>

<h3 id="다짐">다짐</h3>
<p>2024년은 계획한 목표에 도전해보고 이뤄낸 것들이 많은 해였습니다. 그래서인지 그 어느 때보다 더 만족스러웠지만, 항상 그렇듯 아쉬운 점은 남아있습니다. 올해는 그 부분들을 채워보려고 합니다. 그러기 위해서는 크고 작은 목표를 많이 세우는 게 중요하다고 생각하는데요. 회고 덕분에 목표를 제대로 정리해볼 수 있어서 정말 좋았습니다. 목표 달성률을 높이려면 계속 상기시켜야 하니까 이 글에 2주마다 들어와서 목표가 어느 정도 진행되고 있는지 써보겠습니다 <strong>(어디 한 번 해보자고!)</strong>
 <br />
 <br /></p>

<hr />

<h3 id="ing">~ing</h3>

<p><strong>2025.02.16</strong> 한 달만에 와버렸다 😢</p>
<ul>
  <li>아플 때 빼고 주 4회 운동 🫶</li>
  <li>개발 역량을 위해 잇츠 스터디 시작 (오늘 첫 공식 모임!)</li>
  <li>트러블 슈팅을 나름 꼬박꼬박 하고 있지만 조금 더 자주 쓰자</li>
</ul>

<p><strong>TODO</strong></p>
<ul>
  <li>2월에 테스트코드 강의 끝내기</li>
  <li>이번주에 질투라는 감옥 완독하기</li>
</ul>

<p><strong>2025.01.18</strong></p>
<ul>
  <li>튜링의 사과 방문 w.승현님</li>
  <li>다진마늘 출석률 부족… 조금 더 힘내자</li>
  <li>이번주까지 주 4회 운동 👍</li>
</ul>

<p><strong>2025.01.01 ~</strong></p>
<ul>
  <li>유튜브 프리미엄 해지</li>
  <li>핸드폰 게임 삭제</li>
  <li>매일 말해보카 출석</li>
</ul>]]></content><author><name>Dajeong Park</name></author><category term="blog" /><category term="2024회고" /><category term="2025다짐" /><category term="글또" /><category term="글또10기" /><summary type="html"><![CDATA[]]></summary></entry><entry><title type="html">API 문서 자동화로 시간 절약하기 (feat.Swagger)</title><link href="http://localhost:4000/wiki/2024/12/23/spring-swagger.html" rel="alternate" type="text/html" title="API 문서 자동화로 시간 절약하기 (feat.Swagger)" /><published>2024-12-23T00:00:00+09:00</published><updated>2024-12-23T00:00:00+09:00</updated><id>http://localhost:4000/wiki/2024/12/23/spring-swagger</id><content type="html" xml:base="http://localhost:4000/wiki/2024/12/23/spring-swagger.html"><![CDATA[<h4 id="배경">배경</h4>
<p>백엔드 개발자에게 API란 무엇일까요. 열심히 설계하고 작성한 코드가 의미가 있으려면, 그걸 받아서 작업하는 프론트 또는 앱 개발자분들에게 잘 전달되어야겠죠. 그렇습니다. API를 잘 작성하는 것도 중요하지만, 그걸 잘 전달하는 것 또한 매우 중요합니다. 그래서 API를 잘 전달하기 위해 API 명세서를 작성하는 방법을 소개해볼까 합니다. 제가 실무에서 작업한 방법을 알려드리는 것이니, 더 좋은 방법이나 틀린 곳이 있다면 언제든지 댓글 부탁드리겠습니다.
<br />
<br /></p>

<h3 id="swagger">Swagger</h3>
<h4 id="swagger란">Swagger란?</h4>

<ul>
  <li>Swagger는 API 명세서(문서)를 자동으로 생성 및 관리하기 위한 도구로, OpenAPI Specification(OAS)를 기반으로 API 설계 및 문서회에 활용할 수 있습니다.</li>
  <li>Swagger의 주요 장점
    <ul>
      <li>개발 속도 향상</li>
      <li>문서와 API 코드 간의 동기화 가능</li>
      <li>Swagger UI로 실시간 API 테스트 가능
<br />
<br /></li>
    </ul>
  </li>
</ul>

<h4 id="swagger-설치-및-설정-방법">Swagger 설치 및 설정 방법</h4>

<p><strong>1. 의존성 추가</strong></p>
<ul>
  <li>Swagger를 사용하기 위해 springdoc-openapi 라이브러리를 설치해주겠습니다.</li>
  <li>springfox는 더이상 지원하지 않으므로 사용을 권장하지 않습니다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">implementation</span> <span class="err">'</span><span class="n">org</span><span class="o">.</span><span class="na">springdoc</span><span class="o">:</span><span class="n">springdoc</span><span class="o">-</span><span class="n">openapi</span><span class="o">-</span><span class="n">starter</span><span class="o">-</span><span class="n">webmvc</span><span class="o">-</span><span class="nl">ui:</span><span class="mf">2.2</span><span class="o">.</span><span class="mi">0</span><span class="err">'</span>
</code></pre></div></div>

<p><strong>2 Swagger 설정 클래스 추가 (공통)</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@OpenAPIDefinition</span><span class="o">(</span>
        <span class="n">info</span> <span class="o">=</span> <span class="nd">@Info</span><span class="o">(</span>
                <span class="n">title</span> <span class="o">=</span> <span class="s">"Test API Document"</span><span class="o">,</span>
                <span class="n">version</span> <span class="o">=</span> <span class="s">"v1"</span>
        <span class="o">)</span>
<span class="o">)</span>
<span class="nd">@Configuration</span>
<span class="kd">class</span> <span class="nc">SwaggerConfig</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">OpenAPI</span> <span class="nf">getOpenAPI</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nf">OpenAPI</span><span class="o">()</span>
                <span class="o">.</span><span class="na">components</span><span class="o">(</span><span class="k">new</span> <span class="nc">Components</span><span class="o">());</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p><img alt="swagger-ui-common-setting" src="https://github.com/user-attachments/assets/4177ac6b-a378-4143-9a42-bcfb2ff081a5" /></p>

<p><strong>3. 그룹별 Swagger 설정 클래스 추가</strong></p>
<ul>
  <li>그룹별로 API를 나눠서 제공하면 사용자가 보다 편리하게 문서를 이용할 수 있습니다.</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">class</span> <span class="nc">UserSwaggerConfig</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="nc">GroupedOpenApi</span> <span class="nf">userDocs</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nc">GroupedOpenApi</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
                <span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="s">"고객 API"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">packagesToScan</span><span class="o">(</span><span class="s">"com.test.test.user"</span><span class="o">)</span>
                <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
<p><img alt="swagger-ui-group-setting" src="https://github.com/user-attachments/assets/39bab756-d150-474a-ab4c-1330b385129d" />
<br />
<br /></p>

<h4 id="swagger-어노테이션-사용-방법">Swagger 어노테이션 사용 방법</h4>

<p><strong>1. Controller</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Tag</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"고객"</span><span class="o">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s">"고객 관련 API입니다."</span><span class="o">)</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/api/user"</span><span class="o">)</span>
<span class="nd">@RequiredArgsConstructor</span>
<span class="nd">@RestController</span>
<span class="kd">class</span> <span class="nc">UserController</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">final</span> <span class="nc">UserService</span> <span class="n">userService</span><span class="o">;</span>

    <span class="nd">@Operation</span><span class="o">(</span><span class="n">summary</span> <span class="o">=</span> <span class="s">"summary : 이메일 인증번호 전송"</span><span class="o">,</span>
            <span class="n">description</span> <span class="o">=</span> <span class="s">"""
                    ## 요청 :
                    - String email 이메일 (필수)
                    ## 응답 :
                    - String data "</span><span class="n">success</span><span class="s">"
                    """</span><span class="o">)</span>
    <span class="nd">@BasicApiSwaggerResponse</span>
    <span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"/send-email"</span><span class="o">)</span>
    <span class="nc">ResponseEntity</span><span class="o">&lt;</span><span class="nc">CommonResponse</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;&gt;</span> <span class="nf">sendEmail</span><span class="o">(</span><span class="nd">@Valid</span> <span class="nd">@RequestBody</span> <span class="nc">SendEmailRequest</span> <span class="n">request</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">userService</span><span class="o">.</span><span class="na">sendEmail</span><span class="o">(</span><span class="n">request</span><span class="o">);</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nc">ResponseEntity</span><span class="o">&lt;&gt;(</span><span class="k">new</span> <span class="nc">CommonResponse</span><span class="o">&lt;&gt;(</span><span class="s">"이메일 인증번호 전송"</span><span class="o">,</span> <span class="nc">MessageConstants</span><span class="o">.</span><span class="na">SUCCESS_MESSAGE</span><span class="o">),</span> <span class="nc">HttpStatus</span><span class="o">.</span><span class="na">OK</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li><strong>@Tag</strong>: API 그룹 설정
    <ul>
      <li>name: 태그명</li>
      <li>description: 태그에 대한 설명</li>
    </ul>
  </li>
  <li><strong>@Operation</strong>: API에 대한 설명
    <ul>
      <li>summary: API 요약</li>
      <li>description: API 상세 설명</li>
    </ul>
  </li>
</ul>

<p><strong>2. Request class</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Getter</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SaveNoticeRequest</span> <span class="o">{</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Schema</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"language"</span><span class="o">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s">"언어"</span><span class="o">,</span> <span class="n">example</span> <span class="o">=</span> <span class="s">"ko"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">Language</span> <span class="n">language</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Schema</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"category"</span><span class="o">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s">"카테고리"</span><span class="o">,</span> <span class="n">example</span> <span class="o">=</span> <span class="s">"공지"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">category</span><span class="o">;</span>
    
    <span class="nd">@NotNull</span>
    <span class="nd">@Schema</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"title"</span><span class="o">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s">"제목"</span><span class="o">,</span> <span class="n">example</span> <span class="o">=</span> <span class="s">"제목"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">title</span><span class="o">;</span>

    <span class="nd">@NotNull</span>
    <span class="nd">@Schema</span><span class="o">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"content"</span><span class="o">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s">"내용"</span><span class="o">,</span> <span class="n">example</span> <span class="o">=</span> <span class="s">"내용"</span><span class="o">)</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">content</span><span class="o">;</span>
<span class="o">}</span>
</code></pre></div></div>

<ul>
  <li><strong>@Schema</strong>: 해당 Schema에 대한 설명
    <ul>
      <li>name: 스키마 이름</li>
      <li>description: 설명</li>
      <li>example: 예시</li>
    </ul>
  </li>
  <li>@Schema를 작성하여 요청값에 대한 정확한 설명을 적어주면 API 명세서가 더 완성도 있게 작성될 수 있습니다.
    <ul>
      <li>이외에도 allowValues, defaultValue 같은 옵션이 있으니 잘 적용해보면 좋겠습니다.
<br />
<br /></li>
    </ul>
  </li>
</ul>

<h4 id="swagger의-장단점">Swagger의 장단점</h4>
<p><strong>장점</strong></p>
<ol>
  <li>API 문서의 자동화</li>
  <li>협업 및 커뮤니케이션 강화</li>
  <li>실시간 테스트 및 디버깅 가능</li>
</ol>

<p><strong>단점</strong></p>
<ol>
  <li>코드와 문서가 따로 관리될 경우 실제 동작과 불일치 가능</li>
  <li>어노테이션으로 인해 코드 복잡성 증가
<br />
<br /></li>
</ol>

<h4 id="swagger-실무-활용-팁">Swagger 실무 활용 팁</h4>
<p><strong>1. @BasicApiSwaggerResponse 설정</strong>
위의 코드 예제에서 사용한 것처럼  @BasicApiSwaggerResponse 같은 응답 상태 코드를 설명해주는 어노테이션을 만들어두고 사용하면 편리합니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Retention</span><span class="o">(</span><span class="nc">RetentionPolicy</span><span class="o">.</span><span class="na">RUNTIME</span><span class="o">)</span>
<span class="nd">@Target</span><span class="o">({</span><span class="nc">ElementType</span><span class="o">.</span><span class="na">TYPE</span><span class="o">,</span> <span class="nc">ElementType</span><span class="o">.</span><span class="na">METHOD</span><span class="o">})</span>
<span class="nd">@Documented</span>
<span class="nd">@ApiResponses</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="o">{</span>
        <span class="nd">@ApiResponse</span><span class="o">(</span><span class="n">responseCode</span> <span class="o">=</span> <span class="s">"200"</span><span class="o">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s">"API 호출 성공"</span><span class="o">),</span>
        <span class="nd">@ApiResponse</span><span class="o">(</span><span class="n">responseCode</span> <span class="o">=</span> <span class="s">"400"</span><span class="o">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s">"잘못된 요청"</span><span class="o">),</span>
        <span class="nd">@ApiResponse</span><span class="o">(</span><span class="n">responseCode</span> <span class="o">=</span> <span class="s">"404"</span><span class="o">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s">"존재하지 않는 API"</span><span class="o">),</span>
        <span class="nd">@ApiResponse</span><span class="o">(</span><span class="n">responseCode</span> <span class="o">=</span> <span class="s">"403"</span><span class="o">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s">"인가 실패(권한 없음)"</span><span class="o">),</span>
        <span class="nd">@ApiResponse</span><span class="o">(</span><span class="n">responseCode</span> <span class="o">=</span> <span class="s">"500"</span><span class="o">,</span> <span class="n">description</span> <span class="o">=</span> <span class="s">"서버 에러"</span><span class="o">)</span>
<span class="o">})</span>
<span class="kd">public</span> <span class="nd">@interface</span> <span class="nc">BasicApiSwaggerResponse</span> <span class="o">{}</span>
</code></pre></div></div>

<p><strong>2. JWT 설정</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Configuration</span>
<span class="kd">class</span> <span class="nc">SwaggerConfig</span> <span class="o">{</span>

        <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="nc">String</span> <span class="no">TOKEN_PREFIX</span> <span class="o">=</span> <span class="s">"Bearer"</span><span class="o">;</span>
        
        <span class="nd">@Bean</span>
        <span class="kd">public</span> <span class="nc">OpenAPI</span> <span class="nf">getOpenAPI</span><span class="o">()</span> <span class="o">{</span>
                <span class="nc">String</span> <span class="n">securityJwt</span> <span class="o">=</span> <span class="s">"JWT"</span><span class="o">;</span>
                <span class="nc">SecurityRequirement</span> <span class="n">securityRequirement</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SecurityRequirement</span><span class="o">().</span><span class="na">addList</span><span class="o">(</span><span class="n">securityJwt</span><span class="o">);</span>
                <span class="nc">Components</span> <span class="n">components</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Components</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">addSecuritySchemes</span><span class="o">(</span><span class="n">securityJwt</span><span class="o">,</span> <span class="k">new</span> <span class="nc">SecurityScheme</span><span class="o">()</span>
                                <span class="o">.</span><span class="na">name</span><span class="o">(</span><span class="n">securityJwt</span><span class="o">)</span>
                                <span class="o">.</span><span class="na">type</span><span class="o">(</span><span class="nc">SecurityScheme</span><span class="o">.</span><span class="na">Type</span><span class="o">.</span><span class="na">HTTP</span><span class="o">)</span>
                                <span class="o">.</span><span class="na">scheme</span><span class="o">(</span><span class="no">TOKEN_PREFIX</span><span class="o">)</span>
                                <span class="o">.</span><span class="na">bearerFormat</span><span class="o">(</span><span class="nc">HttpHeaders</span><span class="o">.</span><span class="na">AUTHORIZATION</span><span class="o">)</span>
                        <span class="o">);</span>

                <span class="k">return</span> <span class="k">new</span> <span class="nf">OpenAPI</span><span class="o">()</span>
                        <span class="o">.</span><span class="na">addSecurityItem</span><span class="o">(</span><span class="n">securityRequirement</span><span class="o">)</span>
                        <span class="o">.</span><span class="na">components</span><span class="o">(</span><span class="n">components</span><span class="o">);</span>
        <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>]]></content><author><name>Dajeong Park</name></author><category term="wiki" /><category term="Spring" /><category term="SpringBoot" /><category term="Swagger" /><category term="SpringAPIDocs" /><category term="글또" /><category term="글또10기" /><summary type="html"><![CDATA[배경 백엔드 개발자에게 API란 무엇일까요. 열심히 설계하고 작성한 코드가 의미가 있으려면, 그걸 받아서 작업하는 프론트 또는 앱 개발자분들에게 잘 전달되어야겠죠. 그렇습니다. API를 잘 작성하는 것도 중요하지만, 그걸 잘 전달하는 것 또한 매우 중요합니다. 그래서 API를 잘 전달하기 위해 API 명세서를 작성하는 방법을 소개해볼까 합니다. 제가 실무에서 작업한 방법을 알려드리는 것이니, 더 좋은 방법이나 틀린 곳이 있다면 언제든지 댓글 부탁드리겠습니다.]]></summary></entry></feed>