---
layout: post
title: JPA Auditingìœ¼ë¡œ ì—”í‹°í‹° ë³€ê²½ ì´ë ¥ ê´€ë¦¬í•˜ê¸°
categories: wiki
subtitle: 
tags: [JPA, Auditing]
---
Spring Data JPAì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì œê³µí•´ì£¼ëŠ” ê¸°ëŠ¥ ì¤‘ í¸ë¦¬í•œ ê¸°ëŠ¥ë“¤ì´ ë§ì€ë°, ê·¸ì¤‘ ë‚´ê²Œ ì¶©ê²©ì„ ì£¼ì—ˆë˜ ê¸°ëŠ¥ì´ ë°”ë¡œ Auditingì´ì—ˆë‹¤. 
MyBatisì—ì„œëŠ” ì¼ì¼ì´ ì„¤ì •í•˜ê±°ë‚˜ ì§€ì •í•´ì¤˜ì•¼ í–ˆë˜ ë¶€ë¶„ì´ ê¸°ëŠ¥ìœ¼ë¡œ ìˆë‹¤ë‹ˆ.. 
ì˜¤ëŠ˜ì€ JPA Auditingì— ëŒ€í•´ì„œ ìì„¸íˆ ì•Œì•„ë³´ê³ , ì•„ì§ ì‚¬ìš©í•´ë³´ì§€ ëª»í•œ AuditorAware ê¸°ëŠ¥ê³¼ ì‹¤ë¬´ì—ì„œ ê²ªì—ˆë˜ íŠ¸ëŸ¬ë¸” ìŠˆíŒ…ê¹Œì§€ ì¶”ê°€í•´ì„œ ê¸°ë¡í•´ë‘ë ¤ê³  í•œë‹¤.
<br/>
<br/>
<br/>


## JPA Auditing
Auditì€ ì‚¬ì „ì ìœ¼ë¡œ â€˜ê°ì‚¬í•˜ë‹¤â€™, â€˜ë‹¨ì†í•˜ë‹¤â€™ë¼ëŠ” ëœ»ì„ ê°€ì§€ê³  ìˆë‹¤. JPAì—ì„œëŠ” Auditingì„ ì œê³µí•˜ì—¬ ì—”í‹°í‹°ê°€ ì–¸ì œ í˜¹ì€ ëˆ„ê°€ ìƒì„±í•˜ê±°ë‚˜ ë³€ê²½í–ˆëŠ”ì§€ë¥¼ ìë™ìœ¼ë¡œ ì¶”ì (ë‹¨ì†)í•˜ëŠ” ê¸°ëŠ¥ì„ ì œê³µí•œë‹¤.
Auditingì„ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ì—”í‹°í‹° í´ë˜ìŠ¤ì— Auditing ì •ë³´ë¥¼ í¬í•¨í•œ ë©”íƒ€ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ê³ , ì–´ë…¸í…Œì´ì…˜ì„ ì‚¬ìš©í•˜ê±°ë‚˜ íŠ¹ì • ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•˜ì—¬ ì •ì˜í•  ìˆ˜ ìˆë‹¤.
<br/>
<br/>
<br/>


## Auditing ì ìš©

### Application.class
```java
@EnableJpaAuditing
@SpringBootApplication
public class Application {

    public static void main(String[] args) {
        SpringApplication.run(CaffeineApplication.class, args);
    }
}

```
**`@EnableJpaAuditing`**
- JPA Auditingì„ í™œì„±í•˜ê¸° ìœ„í•œ ì–´ë…¸í…Œì´ì…˜ìœ¼ë¡œ, ì´ë ‡ê²Œ Applicationë‹¨ì˜ main ë©”ì†Œë“œì— ë¶™ì—¬ì£¼ê±°ë‚˜ Config í´ë˜ìŠ¤ë¥¼ ë”°ë¡œ ìƒì„±í•˜ì—¬ ì„¤ì •í•´ì¤„ ìˆ˜ ìˆë‹¤.

### BaseTimeEntity.class
```java
@MappedSuperclass
@EntityListeners(AuditingEntityListener.class)
public abstract class BaseDateTimeEntity {

    @CreatedDate
    private LocalDateTime createdDateTime;

    @LastModifiedDate
    private LocalDateTime modifiedDateTime;
}
```

**`@MappedSuperclass`**
- JPA Entity í´ë˜ìŠ¤ë“¤ì´ BaseTimeEntity í´ë˜ìŠ¤ë¥¼ ìƒì†í•  ê²½ìš° í•„ë“œë“¤(createdDateTime, modifiedDateTime)ì„ ì»¬ëŸ¼ìœ¼ë¡œ ì¸ì‹í•˜ë„ë¡ í•œë‹¤.

**`@EntityListeners(AuditingEntityListener.class)`**
- BaseTimeEntity í´ë˜ìŠ¤ì— Auditing ê¸°ëŠ¥ì„ í¬í•¨ì‹œí‚¨ë‹¤.

**`@CreatedDate`**
- Entityê°€ ìƒì„±ë˜ì–´ ì €ì¥ë  ë•Œ ì‹œê°„ì´ ìë™ ì €ì¥ëœë‹¤.

**`@LastModifiedDate`**
- ì¡°íšŒí•œ Entityì˜ ê°’ì„ ë³€ê²½í•  ë•Œ ì‹œê°„ì´ ìë™ ì €ì¥ëœë‹¤.
<br/>

### **â• @MappedSuperclassë€?**
```java
@Documented
@Target(TYPE)
@Retention(RUNTIME)
public @interface MappedSuperclass
```
- MappedSuperclassëŠ” ìƒìœ„ í´ë˜ìŠ¤ë¡œë¶€í„° ë§¤í•‘ ì •ë³´ë¥¼ ìƒì† ë°›ëŠ” í´ë˜ìŠ¤ì„ì„ ì§€ì •í•˜ëŠ” ì–´ë…¸í…Œì´ì…˜ì´ë‹¤.
- ì§€ì •ëœ í´ë˜ìŠ¤ ìì²´ëŠ” ë³„ë„ì˜ í…Œì´ë¸”ì´ ìƒì„±ë˜ì§€ ì•ŠëŠ”ë‹¤. (== ìƒì†í•˜ëŠ” í•˜ìœ„ í´ë˜ìŠ¤ì—ë§Œ ì ìš©ëœë‹¤.)
- í•˜ìœ„ í´ë˜ìŠ¤ì—ì„œëŠ” ìƒì†ëœ ë§¤í•‘ ì •ë³´ê°€ í•´ë‹¹ í´ë˜ìŠ¤ì˜ í…Œì´ë¸”ì— ì ìš©ë˜ê³ , `@AttributeOverride`, `@AssociationOverride` ì• ë…¸í…Œì´ì…˜ (ë˜ëŠ” XML)ì„ ì‚¬ìš©í•˜ë©´ ë§¤í•‘ ì •ë³´ë¥¼ ì¬ì •ì˜í•  ìˆ˜ë„ ìˆë‹¤.  
<br/>
<br/>
<br/>


## AuditorAware
ê·¸ë ‡ë‹¤ë©´ AuditorAwareëŠ” ë­˜ê¹Œ? 
ì•„ì§ ì§ì ‘ ì¨ë³¸ ì  ì—†ì§€ë§Œ ìƒì„±ì¼, ìˆ˜ì •ì¼ì²˜ëŸ¼ ìƒì„±ì, ìˆ˜ì •ì ê°™ì€ ì‚¬ìš©ì ì •ë³´ë„ JPA Auditingì„ í†µí•´ ìë™ìœ¼ë¡œ ì…ë ¥í•´ì¤„ ìˆ˜ ìˆë‹¤.
ìƒì„±ì¼, ìˆ˜ì •ì¼ê³¼ëŠ” êµ¬í˜„ì²´ë¥¼ ì„¤ì •í•˜ê³  ê·¸ êµ¬í˜„ì²´ë¥¼ JWT ê°™ì€ ì¸ì¦ í† í°ì„ ê²€ì‚¬í•  ë•Œ ê°™ì´ ë„£ì–´ì£¼ë©´ ëœë‹¤.

### UserAuditAware.class
```java
@Service
public class UserAuditAware implements AuditorAware<Long> {

    @Override
    public Optional<Long> getCurrentAuditor() {
        Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
        if (authentication == null || !authentication.isAuthenticated()) {
            return Optional.empty();
        }

        CustomUserDetails userDetails = (CustomUserDetails) authentication.getPrincipal();
        return Optional.of(userDetails.getId());
    }
}
```

### Application.class
```java
@EnableJpaAuditing(auditorAwareRef = "userAuditorAware")
@SpringBootApplication
public class Application {

    public static void main(String[] args) {
        SpringApplication.run(CaffeineApplication.class, args);
    }
}
```

ìœ„ì—ì„œ ì„¤ì •í•´ì¤€ main ë©”ì„œë“œì— êµ¬í˜„í•´ì¤€ í´ë˜ìŠ¤ì˜ ë¹ˆ ì´ë¦„ì„ ì„¤ì •í•´ì£¼ë©´ í•´ë‹¹ í´ë˜ìŠ¤ë¥¼ ì´ìš©í•˜ì—¬ ì‚¬ìš©ì ì •ë³´ë¥¼ ìë™ìœ¼ë¡œ ë“±ë¡í•  ìˆ˜ ìˆê²Œ ëœë‹¤.  
<br/>
<br/>
<br/>


## íŠ¸ëŸ¬ë¸” ìŠˆíŒ… ğŸ’«

### ì–´ë¼ ì™œ updateë¬¸ì˜ ê²°ê³¼ë¥¼ í™•ì¸í•˜ëŠ”ë° createdDateTimeì´ nullë¡œ ì—…ë°ì´íŠ¸ ë˜ì§€â“ğŸ¤”
ìƒì„±ì¼ ì»¬ëŸ¼ì— ì´ë¦„ì„ ì„¤ì •í•˜ê¸° ìœ„í•´ `@Column` ì–´ë…¸í…Œì´ì…˜ì„ ë¶™ì˜€ëŠ”ë°, `@Column`ì˜ ì˜µì…˜ ì¤‘ í•˜ë‚˜ì¸ updatableì˜ ê¸°ë³¸ê°’ì´ trueë¼ì„œ ê°’ì„ ì„¤ì •í•´ì£¼ì§€ ì•Šì€ ìƒì„±ì¼ ì»¬ëŸ¼ì— nullì´ ì—…ë°ì´íŠ¸ëœ ê²ƒì´ë‹¤.

```java
@Target({METHOD, FIELD}) 
@Retention(RUNTIME)
public @interface Column {
	/**
	* (Optional) Whether the column is included in SQL UPDATE 
	* statements generated by the persistence provider.
	*/
	boolean updatable() default **true**;
}
```

ê·¸ë˜ì„œ `@Column`ì„ ì‚¬ìš©í•  ê±°ë¼ë©´ ì•„ë˜ì²˜ëŸ¼ **updatable** ì˜µì…˜ì„ **false**ë¡œ ì§€ì •í•´ì£¼ëŠ” ê²ƒì´ í•„ìš”í•˜ë‹¤.

```java
@CreatedDate
@Column(name = "created_date_time", updatable = false)
private LocalDateTime createdDateTime;
```

ë‹¤ì‹œ ìƒê°í•´ë³´ë‹ˆ `@Column` ì–´ë…¸í…Œì´ì…˜ì„ ê¼­ ì¨ì•¼í• ê¹Œ? í•˜ëŠ” ì˜ë¬¸ì´ ë“¤ì—ˆë‹¤. ë‚´ê°€ `@Column`ì„ ì¼ë˜ ì´ìœ ëŠ” Javaì˜ ì¹´ë©œì¼€ì´ìŠ¤ë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì˜ ìŠ¤ë„¤ì´í¬ì¼€ì´ìŠ¤ì™€ ì—°ê²°ì‹œí‚¤ê³  ì‹¶ì–´ì„œì˜€ë‹¤. 
ê·¸ëŸ°ë° ì•„ë˜ì²˜ëŸ¼ YML íŒŒì¼ì— ì„¤ì •í•˜ë©´ ìë™ ì—°ê²°ì´ ëœë‹¤ë‹ˆ ğŸ’¦ ì•ìœ¼ë¡œëŠ” ì´ëŸ° ì„¤ì • í•˜ë‚˜ë¡œ ì½”ë“œë¥¼ ì¤„ì´ê¸° ìœ„í•´ í•œë²ˆì”©ì€ ê¼­ ì°¾ì•„ë³´ê³  ì‘ì—…í•  í•„ìš”ë¥¼ ëŠê¼ˆë‹¤.

```java
spring:
  jpa:
    hibernate:
      naming:
        physical-strategy: org.hibernate.boot.model.naming.CamelCaseToUnderscoresNamingStrategy
```

â• ì¶”ê°€ë¡œ `@CreatedDate`/`@CreatedBy`ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ì—”í‹°í‹°ê°€ ì²˜ìŒ ì €ì¥ë  ë•Œ ìë™ìœ¼ë¡œ ê°’ì´ ì„¤ì •ë˜ì§€ë§Œ, ì§ì ‘ ë³€ê²½í•˜ê±°ë‚˜ Native Queryë¡œëŠ” ìˆ˜ì • ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì— `@Column(updatable = false)`ì„ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì•ˆì „í•˜ë‹¤.  
<br/>
<br/>  


**ì°¸ê³ **
- [Spring ê³µì‹ ë¬¸ì„œ](https://docs.spring.io/spring-data/jpa/reference/auditing.html)
- [https://hudi.blog/spring-data-jpa-auditing-create-update-date/](https://hudi.blog/spring-data-jpa-auditing-create-update-date/)